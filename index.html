<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AeroNav - Ballon Tracker Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background: #f0fdf4; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255,255,255,0.5);
        }

        #instruments {
            position: absolute; top: 10px; left: 10px; right: 10px;
            z-index: 1000; display: flex; justify-content: space-between; gap: 5px;
        }

        .instrument-box { flex: 1; text-align: center; padding: 8px; }
        .value { font-size: 1.2rem; font-weight: 800; color: #1e3a8a; }
        .label { font-size: 0.6rem; color: #64748b; text-transform: uppercase; }

        #error-overlay {
            position: absolute; top: 70px; left: 10px; right: 10px;
            z-index: 1100; display: none;
        }

        #controls {
            position: absolute; bottom: 20px; left: 10px; right: 10px;
            z-index: 1000; display: flex; flex-direction: column; gap: 10px;
        }

        .btn-large {
            padding: 15px; border-radius: 50px; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .btn-large:active { transform: scale(0.98); }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; width: 95%; max-width: 450px; max-height: 90vh;
            overflow-y: auto; padding: 20px; border-radius: 20px;
        }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 0.75rem; font-weight: bold; color: #475569; margin-bottom: 4px; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem;
        }

        /* Animation für Warnungen */
        @keyframes pulse-red {
            0% { background-color: #ef4444; }
            50% { background-color: #991b1b; }
            100% { background-color: #ef4444; }
        }
        .pulse-error { animation: pulse-red 2s infinite; }
    </style>
</head>
<body>

    <!-- Cockpit -->
    <div id="instruments" class="pointer-events-none">
        <div class="glass-panel instrument-box pointer-events-auto">
            <div class="value" id="disp-alt">0</div>
            <div class="label">m</div>
        </div>
        <div class="glass-panel instrument-box pointer-events-auto">
            <div class="value" id="disp-speed">0</div>
            <div class="label">km/h</div>
        </div>
        <div class="glass-panel instrument-box pointer-events-auto">
            <div class="value" id="disp-heading">---</div>
            <div class="label">Kurs</div>
        </div>
        <div class="glass-panel instrument-box pointer-events-auto">
            <div class="value" id="disp-climb">0.0</div>
            <div class="label">Vario</div>
        </div>
    </div>

    <!-- Error/Status Overlay -->
    <div id="error-overlay" class="pulse-error text-white p-3 rounded-xl shadow-lg flex items-center gap-3">
        <i class="fa-solid fa-triangle-exclamation text-xl"></i>
        <div class="flex-1">
            <div class="font-bold text-sm" id="error-title">GPS Signal verloren</div>
            <div class="text-[10px] opacity-90" id="error-desc">Suche nach Position...</div>
        </div>
        <button onclick="retryGPS()" class="bg-white/20 px-3 py-1 rounded-lg text-xs font-bold">Retry</button>
    </div>

    <div id="map"></div>

    <!-- Hauptsteuerung -->
    <div id="controls" class="pointer-events-none">
        <div class="flex gap-2 pointer-events-auto">
            <button id="btn-toggle" onclick="toggleRecording()" class="btn-large flex-1 bg-green-600 text-white flex items-center justify-center gap-2">
                <i class="fa-solid fa-play"></i> <span id="btn-text">Fahrt starten</span>
            </button>
            <button onclick="openMenu()" class="btn-large bg-white text-indigo-600 w-16 flex items-center justify-center border-2 border-indigo-100">
                <i class="fa-solid fa-bars-staggered"></i>
            </button>
        </div>
    </div>

    <!-- Modal: Flug speichern -->
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-indigo-900">Fahrt abschließen</h2>
            
            <div class="grid grid-cols-2 gap-2">
                <div class="form-group">
                    <label>Fahrt-Name</label>
                    <input type="text" id="save-name">
                </div>
                <div class="form-group">
                    <label>Ballon (Reg)</label>
                    <input type="text" id="save-reg" placeholder="z.B. D-OXYZ">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div class="form-group">
                    <label>Passagiere</label>
                    <input type="text" id="save-passengers" placeholder="Name 1, Name 2...">
                </div>
                <div class="form-group">
                    <label>Wetter</label>
                    <input type="text" id="save-weather" placeholder="23°C, 3kt NW">
                </div>
            </div>

            <div class="form-group">
                <label>Logbuch Notizen</label>
                <textarea id="save-notes" rows="3" placeholder="Startplatz, Landung, Besonderheiten..."></textarea>
            </div>

            <div id="save-error" class="hidden text-red-600 text-xs font-bold mb-4 bg-red-50 p-2 rounded-lg"></div>

            <div class="bg-indigo-50 p-3 rounded-lg mb-4 text-xs text-indigo-800 flex justify-between">
                <span>Max: <b id="stat-max-alt">0</b>m</span>
                <span>Zeit: <b id="stat-duration">0</b> min</span>
                <span>Track: <b id="stat-points">0</b> Pkt</span>
            </div>

            <div class="flex gap-2">
                <button onclick="confirmSave()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">Speichern</button>
                <button onclick="closeSaveModal()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Logbuch Menü -->
    <div id="menu-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Logbuch & Historie</h2>
                <button onclick="closeMenu()" class="text-gray-400 p-2"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div id="saved-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>

            <div class="mt-6 pt-4 border-t space-y-2">
                <button onclick="toggleSimulation()" id="sim-btn" class="w-full py-3 px-4 rounded-xl bg-purple-50 text-purple-700 font-bold text-sm flex items-center justify-between">
                    <span><i class="fa-solid fa-robot mr-2"></i> Demo-Modus</span>
                    <i class="fa-solid fa-play"></i>
                </button>
                <button onclick="closeMenu()" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold">Schließen</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const state = {
            recording: false,
            track: [],
            windLayers: {},
            lastPosTime: null,
            watchId: null,
            maxAlt: 0,
            startTime: null,
            simulationId: null,
            wakeLock: null
        };

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([51.1657, 10.4515], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const trackLine = L.polyline([], { color: '#4f46e5', weight: 4, opacity: 0.8 }).addTo(map);
        const marker = L.circleMarker([0,0], { radius: 8, color: 'white', fillColor: '#4f46e5', fillOpacity: 1, weight: 2 }).addTo(map);

        // --- GPS & ERROR HANDLING ---

        function showError(title, desc) {
            document.getElementById('error-title').innerText = title;
            document.getElementById('error-desc').innerText = desc;
            document.getElementById('error-overlay').style.display = 'flex';
        }

        function hideError() {
            document.getElementById('error-overlay').style.display = 'none';
        }

        function retryGPS() {
            if (state.watchId) navigator.geolocation.clearWatch(state.watchId);
            startGPSWatch();
        }

        function startGPSWatch() {
            if (!navigator.geolocation) {
                showError("Hardware Fehler", "GPS wird von diesem Gerät nicht unterstützt.");
                return;
            }

            state.watchId = navigator.geolocation.watchPosition(
                handlePosition, 
                (err) => {
                    let msg = "Unbekannter Fehler";
                    if(err.code === 1) msg = "Standortzugriff verweigert.";
                    if(err.code === 2) msg = "Position nicht verfügbar (Funkloch?).";
                    if(err.code === 3) msg = "Zeitüberschreitung (Timeout).";
                    showError("GPS Fehler", msg);
                }, 
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        // Überprüfung auf Signalverlust (Watchdog)
        setInterval(() => {
            if (state.recording && state.lastPosTime) {
                const diff = (Date.now() - state.lastPosTime) / 1000;
                if (diff > 15) {
                    showError("Signalverlust", `Seit ${Math.round(diff)}s keine neuen GPS Daten.`);
                } else if (diff < 5) {
                    hideError();
                }
            }
        }, 5000);

        // --- WAKE LOCK (Display anlassen) ---
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    state.wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
                console.warn("WakeLock konnte nicht aktiviert werden");
            }
        }

        // --- DATENVERARBEITUNG ---

        function handlePosition(pos) {
            state.lastPosTime = Date.now();
            const { latitude, longitude, altitude, speed, heading } = pos.coords;
            processData(latitude, longitude, altitude || 0, (speed || 0) * 3.6, heading, pos.timestamp);
        }

        function processData(lat, lng, alt, speedKmh, heading, time) {
            if (alt > state.maxAlt) state.maxAlt = alt;
            
            document.getElementById('disp-alt').innerText = Math.round(alt);
            document.getElementById('disp-speed').innerText = Math.round(speedKmh);
            document.getElementById('disp-heading').innerText = heading ? Math.round(heading) + "°" : "---";

            const latlng = [lat, lng];
            marker.setLatLng(latlng);

            if (state.recording) {
                // Check auf plausible Daten (GPX Drift verhindern)
                if (state.track.length > 0) {
                    const last = state.track[state.track.length - 1];
                    if (last.lat === lat && last.lng === lng) return; // Keine Duplikate
                }

                state.track.push({ lat, lng, alt, speedKmh, heading, time });
                trackLine.addLatLng(latlng);
                map.panTo(latlng);
            }
        }

        function toggleRecording() {
            if (!state.recording) {
                // Check ob GPS überhaupt läuft
                if (!state.lastPosTime && !state.simulationId) {
                    alert("Warte auf GPS Signal...");
                    startGPSWatch();
                    return;
                }
                
                state.recording = true;
                state.startTime = Date.now();
                state.track = [];
                state.maxAlt = 0;
                trackLine.setLatLngs([]);
                
                requestWakeLock();
                document.getElementById('btn-toggle').className = "btn-large flex-1 bg-red-600 text-white flex items-center justify-center gap-2";
                document.getElementById('btn-text').innerText = "Fahrt stoppen";
                startGPSWatch();
            } else {
                state.recording = false;
                if (state.wakeLock) state.wakeLock.release().then(() => state.wakeLock = null);
                openSaveModal();
            }
        }

        function openSaveModal() {
            document.getElementById('save-modal').style.display = 'flex';
            document.getElementById('save-name').value = `Fahrt ${new Date().toLocaleDateString()}`;
            document.getElementById('stat-max-alt').innerText = Math.round(state.maxAlt);
            document.getElementById('stat-points').innerText = state.track.length;
            const duration = Math.round((Date.now() - state.startTime) / 60000);
            document.getElementById('stat-duration').innerText = duration;
            document.getElementById('save-error').classList.add('hidden');
        }

        function closeSaveModal() { 
            document.getElementById('save-modal').style.display = 'none'; 
            resetUI(); 
        }

        function resetUI() {
            document.getElementById('btn-toggle').className = "btn-large flex-1 bg-green-600 text-white flex items-center justify-center gap-2";
            document.getElementById('btn-text').innerText = "Fahrt starten";
        }

        function confirmSave() {
            if (state.track.length < 2) {
                document.getElementById('save-error').innerText = "Zu wenig Datenpunkte für eine Aufzeichnung.";
                document.getElementById('save-error').classList.remove('hidden');
                return;
            }

            try {
                const flight = {
                    id: Date.now(),
                    name: document.getElementById('save-name').value || "Unbenannt",
                    registration: document.getElementById('save-reg').value,
                    passengers: document.getElementById('save-passengers').value,
                    weather: document.getElementById('save-weather').value,
                    notes: document.getElementById('save-notes').value,
                    maxAlt: state.maxAlt,
                    duration: Math.round((Date.now() - state.startTime) / 60000),
                    track: state.track,
                    date: new Date().toISOString()
                };
                
                const flights = JSON.parse(localStorage.getItem('flights') || '[]');
                flights.push(flight);
                localStorage.setItem('flights', JSON.stringify(flights));
                closeSaveModal();
            } catch (e) {
                document.getElementById('save-error').innerText = "Fehler beim Speichern: Speicher voll?";
                document.getElementById('save-error').classList.remove('hidden');
            }
        }

        // --- MENÜ & EXPORT ---

        function openMenu() {
            document.getElementById('menu-modal').style.display = 'flex';
            renderHistory();
        }

        function closeMenu() { document.getElementById('menu-modal').style.display = 'none'; }

        function renderHistory() {
            const list = document.getElementById('saved-list');
            const flights = JSON.parse(localStorage.getItem('flights') || '[]');
            if (!flights.length) {
                list.innerHTML = `<div class="p-8 text-center text-gray-400 italic">Noch keine Einträge vorhanden.</div>`;
                return;
            }
            list.innerHTML = flights.reverse().map(f => `
                <div class="bg-white border-2 border-slate-100 rounded-2xl p-4 shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h3 class="font-bold text-indigo-900 truncate">${f.name}</h3>
                            <p class="text-[10px] text-gray-400">${new Date(f.date).toLocaleString()} | ${f.registration || 'Keine Reg.'}</p>
                        </div>
                        <span class="bg-indigo-50 text-indigo-600 text-[10px] px-2 py-1 rounded-full font-bold ml-2">${f.maxAlt}m</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportGPX(${f.id})" class="flex-1 py-2 bg-green-50 text-green-700 rounded-lg font-bold text-xs"><i class="fa-solid fa-download mr-1"></i> GPX</button>
                        <button onclick="loadToMap(${f.id})" class="flex-1 py-2 bg-blue-50 text-blue-700 rounded-lg font-bold text-xs"><i class="fa-solid fa-map-location-dot mr-1"></i> Karte</button>
                        <button onclick="deleteFlight(${f.id})" class="w-10 py-2 bg-red-50 text-red-400 rounded-lg"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function exportGPX(id) {
            const f = JSON.parse(localStorage.getItem('flights')).find(x => x.id === id);
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="AeroNav Balloon" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata>
    <name>${f.name}</name>
    <desc>Reg: ${f.registration || 'N/A'}, Pax: ${f.passengers || 'N/A'}, Wetter: ${f.weather || 'N/A'}</desc>
    <time>${f.date}</time>
  </metadata>
  <trk><name>${f.name}</name><trkseg>`;
            f.track.forEach(pt => {
                gpx += `\n<trkpt lat="${pt.lat}" lon="${pt.lng}"><ele>${pt.alt}</ele><time>${new Date(pt.time).toISOString()}</time></trkpt>`;
            });
            gpx += `\n</trkseg></trk></gpx>`;
            
            const blob = new Blob([gpx], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${f.name.replace(/[^\w]/g, '_')}.gpx`;
            a.click();
        }

        function loadToMap(id) {
            const f = JSON.parse(localStorage.getItem('flights')).find(x => x.id === id);
            trackLine.setLatLngs(f.track.map(p => [p.lat, p.lng]));
            map.fitBounds(trackLine.getBounds());
            closeMenu();
        }

        function deleteFlight(id) {
            if (confirm("Diesen Flug endgültig aus dem Logbuch löschen?")) {
                const flights = JSON.parse(localStorage.getItem('flights')).filter(x => x.id !== id);
                localStorage.setItem('flights', JSON.stringify(flights));
                renderHistory();
            }
        }

        function toggleSimulation() {
            const btn = document.getElementById('sim-btn');
            if (state.simulationId) { 
                clearInterval(state.simulationId); 
                state.simulationId = null; 
                btn.classList.replace('bg-red-50', 'bg-purple-50');
                btn.querySelector('span').innerText = "Demo-Modus starten";
                return; 
            }
            closeMenu();
            if (!state.recording) toggleRecording();
            btn.classList.replace('bg-purple-50', 'bg-red-50');
            btn.querySelector('span').innerText = "Simulation stoppen";
            
            let lat = 51.16, lng = 10.45, alt = 150;
            state.simulationId = setInterval(() => {
                alt += (Math.random() * 4 - 1.5);
                lat += 0.0002; lng += 0.0001;
                processData(lat, lng, alt, 12, 45, Date.now());
            }, 1000);
        }

        // Init GPS on Load
        window.onload = startGPSWatch;
    </script>
</body>
</html>
