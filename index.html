<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AeroNav Balloon Pilot</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Custom Glassmorphism & UI Tweaks */
        body { overscroll-behavior: none; user-select: none; background-color: #000; }
        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .hud-value { font-variant-numeric: tabular-nums; letter-spacing: 0.05em; }
        .leaflet-control-zoom { display: none; } 
        .wind-bar-item.active { border-left: 4px solid #10b981; background: rgba(16, 185, 129, 0.2); }
        .control-btn:active { transform: scale(0.95); }
        .hidden-ui { display: none !important; }

        /* KML & Map Styles */
        .airspace-label {
            background: transparent;
            border: none;
            box-shadow: none;
            color: rgba(255,255,255,0.7);
            font-weight: bold;
            font-size: 10px;
            text-shadow: 1px 1px 2px black;
        }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background-color: #111827 !important; color: #f3f4f6 !important;
            border: 1px solid #374151; backdrop-filter: blur(4px);
        }
        .leaflet-popup-content, .leaflet-popup-content * { color: #f3f4f6 !important; }
        .leaflet-popup-content table, .leaflet-popup-content td {
            background: transparent !important; border-color: #4b5563 !important;
        }
        .leaflet-container a.leaflet-popup-close-button { color: #9ca3af !important; font-size: 18px !important; padding: 8px !important; }

        /* View Cone (Compass) */
        .compass-cone {
            width: 0; height: 0;
            border-left: 100px solid transparent;
            border-right: 100px solid transparent;
            border-top: 300px solid rgba(59, 130, 246, 0.15);
            filter: blur(10px);
            transform-origin: bottom center;
            opacity: 0.8;
            pointer-events: none;
        }

        /* Mobile Menu Transitions */
        #settings-modal { transition: opacity 0.3s ease; }
        .slide-up-mobile { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* Animations for AI Button */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        .ai-pulse::before {
            content: '';
            position: absolute;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: inherit;
            border-radius: 50%;
            z-index: -1;
            animation: pulse-ring 2s infinite;
        }
        
        /* Speed Legend for Replay */
        .speed-legend-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        
        /* Select styling */
        select.unit-select {
            background-color: #1f2937;
            border: 1px solid #374151;
            color: #e5e7eb;
            font-size: 0.75rem;
            border-radius: 0.25rem;
            padding: 2px 4px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen w-screen overflow-hidden font-sans">

    <!-- MAP CONTAINER -->
    <div id="map" class="absolute inset-0 z-0 bg-black"></div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="hidden absolute inset-0 z-50 bg-black/80 flex flex-col items-center justify-center">
        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
        <div id="loading-text">Verarbeite KML Daten...</div>
    </div>

    <!-- HUD (Head Up Display) -->
    <div id="hud-top" class="absolute top-0 left-0 right-0 p-2 z-20 flex justify-center pointer-events-none">
        <div class="glass-panel rounded-xl p-3 w-full max-w-4xl flex justify-between items-center pointer-events-auto shadow-lg relative">
            <div class="flex-1 text-center border-r border-gray-700/50">
                <div class="text-[10px] text-gray-400 uppercase tracking-widest">Höhe</div>
                <div class="flex items-baseline justify-center"><span id="hud-alt" class="text-3xl font-bold hud-value">0</span><span id="unit-alt" class="text-xs text-gray-500 ml-1">m</span></div>
            </div>
            <div class="flex-1 text-center border-r border-gray-700/50">
                <div class="text-[10px] text-gray-400 uppercase tracking-widest">Speed</div>
                <div class="flex items-baseline justify-center"><span id="hud-speed" class="text-3xl font-bold hud-value">0</span><span id="unit-speed" class="text-xs text-gray-500 ml-1">km/h</span></div>
            </div>
            <div class="flex-1 text-center border-r border-gray-700/50 relative">
                <div class="text-[10px] text-gray-400 uppercase tracking-widest">Vario</div>
                <div class="flex items-baseline justify-center"><span id="hud-vario" class="text-3xl font-bold hud-value text-gray-300">0.0</span><span id="unit-vario" class="text-xs text-gray-500 ml-1">m/s</span></div>
                <div id="baro-indicator" class="hidden absolute top-0 right-1 text-[8px] font-bold text-yellow-500 border border-yellow-600 rounded px-1" title="Barometer aktiv">BARO</div>
            </div>
            <div class="flex-1 text-center">
                <div class="text-[10px] text-gray-400 uppercase tracking-widest">Kurs</div>
                <div class="flex items-baseline justify-center"><span id="hud-heading" class="text-3xl font-bold hud-value">0</span><span class="text-xs text-gray-500 ml-1">°</span></div>
            </div>
            <div class="absolute -bottom-2 right-2 flex gap-2">
                 <div id="gps-status" class="bg-gray-800/80 px-2 py-0.5 rounded text-[9px] font-bold text-blue-400 border border-gray-700 shadow">SIMULATION</div>
                 <div id="rec-status" class="hidden bg-red-900/80 px-2 py-0.5 rounded text-[9px] font-bold text-red-200 border border-red-700 shadow animate-pulse">REC</div>
            </div>
        </div>
    </div>

    <!-- Right Side: Wind & AI -->
    <div class="absolute right-0 top-24 bottom-24 w-20 z-10 flex flex-col items-end pointer-events-none gap-4">
        <div id="wind-layers" class="glass-panel rounded-l-xl w-full flex flex-col pointer-events-auto overflow-y-auto text-xs border-r-0 flex-1 max-h-[60%]"></div>
        <button onclick="app.ai.openAssistant()" class="glass-panel w-12 h-12 rounded-l-xl flex items-center justify-center bg-blue-600/80 hover:bg-blue-500 text-white shadow-[0_0_15px_rgba(59,130,246,0.5)] border-r-0 pointer-events-auto ai-pulse relative mr-0 transition-all transform hover:scale-105 active:scale-95" title="KI Assistent"><i class="fas fa-robot text-xl"></i></button>
    </div>

    <!-- Controls -->
    <div id="sim-controls" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-30 flex gap-6">
        <button id="btn-valve" class="control-btn glass-panel w-20 h-20 rounded-full flex flex-col items-center justify-center border-red-500/50 hover:bg-red-900/40 text-red-300 active:bg-red-700 transition-all shadow-[0_0_20px_rgba(220,38,38,0.3)]"><i class="fas fa-arrow-down text-2xl"></i><span class="text-xs font-bold mt-1">VENTIL</span></button>
        <button id="btn-burner" class="control-btn glass-panel w-20 h-20 rounded-full flex flex-col items-center justify-center border-green-500/50 hover:bg-green-900/40 text-green-300 active:bg-green-600 transition-all shadow-[0_0_20px_rgba(34,197,94,0.3)]"><i class="fas fa-fire text-2xl"></i><span class="text-xs font-bold mt-1">BRENNER</span></button>
    </div>

    <!-- Main Toolbar (Left Side) -->
    <div class="absolute bottom-6 left-4 z-30 flex flex-col gap-3">
        <button id="btn-record" onclick="app.logbook.toggleRecording()" class="glass-panel p-3 rounded-full hover:bg-red-900/50 w-12 h-12 flex items-center justify-center hidden" title="Track aufzeichnen"><i id="icon-record" class="fas fa-circle text-gray-400"></i></button>
        <button id="btn-center" class="glass-panel p-3 rounded-full hover:bg-blue-900/50 w-12 h-12 flex items-center justify-center text-blue-400 select-none touch-none" title="Kurz: Zentrieren | Lang: Verriegeln"><i id="icon-center" class="fas fa-crosshairs"></i></button>
        <button onclick="app.ui.cycleMapLayer()" class="glass-panel p-3 rounded-full hover:bg-gray-700 w-12 h-12 flex items-center justify-center" title="Kartenstil wechseln"><i class="fas fa-layer-group"></i></button>
        <button onclick="app.toggleSettings()" class="glass-panel p-3 rounded-full hover:bg-gray-700 w-12 h-12 flex items-center justify-center text-gray-200 shadow-lg" title="Menü / Setup"><i class="fas fa-bars"></i></button>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-end landscape:items-center md:items-center justify-center transition-opacity duration-300">
        <div class="glass-panel w-full h-[85vh] md:h-auto md:max-h-[90vh] md:max-w-md landscape:h-auto landscape:max-h-[90vh] landscape:max-w-lg md:rounded-2xl landscape:rounded-2xl rounded-t-2xl p-6 overflow-y-auto slide-up-mobile flex flex-col shadow-2xl">
            
            <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-4 flex-shrink-0">
                <h2 class="text-xl font-bold">Einstellungen</h2>
                <button onclick="app.toggleSettings()" class="text-gray-400 hover:text-white p-2"><i class="fas fa-chevron-down md:fa-times landscape:fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-6 flex-1 overflow-y-auto">
                <!-- Units (NEW) -->
                <div>
                    <label class="block text-sm text-gray-300 font-bold mb-2">Einheiten</label>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-gray-800 p-2 rounded border border-gray-700">
                            <div class="text-[10px] text-gray-400 mb-1">Höhe</div>
                            <select id="sel-alt" class="unit-select w-full" onchange="app.units.setUnit('alt', this.value)">
                                <option value="m">Meter (m)</option>
                                <option value="ft">Fuß (ft)</option>
                            </select>
                        </div>
                        <div class="bg-gray-800 p-2 rounded border border-gray-700">
                            <div class="text-[10px] text-gray-400 mb-1">Speed</div>
                            <select id="sel-spd" class="unit-select w-full" onchange="app.units.setUnit('spd', this.value)">
                                <option value="kmh">km/h</option>
                                <option value="kt">Knoten</option>
                            </select>
                        </div>
                        <div class="bg-gray-800 p-2 rounded border border-gray-700">
                            <div class="text-[10px] text-gray-400 mb-1">Vario</div>
                            <select id="sel-var" class="unit-select w-full" onchange="app.units.setUnit('var', this.value)">
                                <option value="ms">m/s</option>
                                <option value="fts">ft/s</option>
                            </select>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-700/50">

                <!-- Logbook Section -->
                <div>
                    <label class="block text-sm text-green-400 font-bold mb-2"><i class="fas fa-book mr-2"></i> Flug-Logbuch</label>
                    <div id="log-list" class="space-y-2 mb-3 max-h-40 overflow-y-auto pr-1 bg-gray-900/50 rounded-lg p-2 border border-gray-700/50">
                        <div class="text-xs text-gray-500 text-center py-2 italic">Keine Aufzeichnungen</div>
                    </div>
                    <div class="flex gap-4 text-[10px] text-gray-400 justify-center">
                        <div class="flex items-center"><span class="speed-legend-dot bg-blue-500"></span>&lt;<span id="leg-1">10</span></div>
                        <div class="flex items-center"><span class="speed-legend-dot bg-green-500"></span><span id="leg-2">10-25</span></div>
                        <div class="flex items-center"><span class="speed-legend-dot bg-orange-500"></span><span id="leg-3">25-45</span></div>
                        <div class="flex items-center"><span class="speed-legend-dot bg-red-500"></span>&gt;<span id="leg-4">45</span> <span id="leg-u">km/h</span></div>
                    </div>
                </div>

                <!-- Compass Toggle -->
                <div class="flex justify-between items-center">
                    <div>
                        <label class="block text-sm text-gray-200 font-bold">Blickrichtung (Kompass)</label>
                        <p class="text-[10px] text-gray-500">Zeigt Sichtkegel auf Karte</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="compass-toggle-check" class="sr-only peer" onchange="app.compass.toggle()">
                        <div class="w-12 h-7 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>

                <!-- Simulation Mode -->
                <div class="flex justify-between items-center">
                    <div>
                        <label class="block text-sm text-gray-200 font-bold">Simulations-Modus</label>
                        <p class="text-[10px] text-gray-500">Physik statt GPS</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="sim-toggle-check" class="sr-only peer" onchange="app.toggleSimulation()">
                        <div class="w-12 h-7 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>

                <!-- Data Import -->
                <div>
                    <label class="block text-sm text-gray-300 font-bold mb-2">Karten-Ebenen (KML/GPX)</label>
                    <div id="layer-list" class="space-y-2 mb-3 max-h-40 overflow-y-auto pr-1 bg-gray-900/50 rounded-lg p-2 border border-gray-700/50">
                        <div class="text-xs text-gray-500 text-center py-2 italic">Keine Karten geladen</div>
                    </div>
                    <label class="flex flex-col items-center justify-center w-full h-12 border border-gray-600 border-dashed rounded-lg cursor-pointer bg-gray-800/50 hover:bg-gray-700/50">
                        <div class="flex items-center justify-center gap-2"><i class="fas fa-plus text-sm text-gray-400"></i><p class="text-xs text-gray-400">Datei hinzufügen...</p></div>
                        <input type="file" accept=".kml,.gpx,.xml" class="hidden" onchange="app.data.handleKML(this.files[0])" />
                    </label>
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-2">HUD Transparenz</label>
                    <input type="range" min="0.0" max="0.95" step="0.05" value="0.85" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="app.ui.updateOpacity(this.value)">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Gemini API Key</label>
                    <input type="password" id="api-key" placeholder="Key eingeben..." class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white text-xs">
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-700 flex-shrink-0">
                <button onclick="app.data.clearAllData()" class="w-full text-red-400 text-xs hover:text-red-200 flex items-center justify-center py-2"><i class="fas fa-trash-alt mr-2"></i> Alles zurücksetzen</button>
            </div>
             <div class="h-6 md:hidden landscape:hidden"></div>
        </div>
    </div>

    <!-- AI Panel -->
    <div id="ai-panel" class="hidden absolute right-16 bottom-24 z-40 w-80">
        <div class="glass-panel p-4 rounded-xl">
            <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-blue-300"><i class="fas fa-robot mr-1"></i> Gemini Co-Pilot</h3><button onclick="app.ai.close()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button></div>
            <div id="ai-output" class="text-sm text-gray-200 mb-3 min-h-[50px] max-h-[200px] overflow-y-auto">Bereit für Anweisungen. Rechtsklick auf Karte setzt Ziel.</div>
            <div class="flex gap-2"><button onclick="app.ai.analyzeWind()" class="flex-1 bg-purple-700/50 hover:bg-purple-600/50 border border-purple-500 rounded px-2 py-1 text-xs">Wind Analyse</button><button onclick="app.ai.generateLogSummary()" class="flex-1 bg-green-700/50 hover:bg-green-600/50 border border-green-500 rounded px-2 py-1 text-xs">Logbuch</button></div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const CONSTANTS = { GRAVITY: 9.81, OSM_API: 'https://overpass-api.de/api/interpreter' };
        
        // Initial state with units
        const state = { 
            mode: 'simulation', recording: false, gpsLocked: false, 
            position: { lat: 50.1109, lng: 8.6821, alt: 0 }, 
            velocity: { h: 0, v: 0, heading: 0 }, 
            history: [], windLayers: [], target: null, trackPoints: [], 
            apiKey: localStorage.getItem('gemini_key') || '', 
            autoFollow: true, mapLocked: false, lastRecordTime: 0,
            units: { alt: 'm', spd: 'kmh', var: 'ms' } // Defaults
        };

        const Settings = {
            save: () => {
                localStorage.setItem('an_sim_mode', state.mode);
                localStorage.setItem('an_hud_opacity', document.querySelector('input[type=range]').value);
                localStorage.setItem('an_map_layer', app.ui.currentLayerIndex);
                localStorage.setItem('an_units', JSON.stringify(state.units));
            },
            load: () => {
                if (localStorage.getItem('an_sim_mode')) state.mode = localStorage.getItem('an_sim_mode');
                if (localStorage.getItem('an_hud_opacity')) {
                    const op = localStorage.getItem('an_hud_opacity');
                    app.ui.updateOpacity(op);
                    document.querySelector('input[type=range]').value = op;
                }
                if (localStorage.getItem('an_map_layer')) app.ui.currentLayerIndex = parseInt(localStorage.getItem('an_map_layer'));
                if (localStorage.getItem('an_units')) {
                    try { state.units = JSON.parse(localStorage.getItem('an_units')); } catch(e){}
                }
            }
        };

        // --- UNIT MANAGER ---
        class UnitManager {
            constructor() {
                // Formatting constants
                this.M_TO_FT = 3.28084;
                this.KMH_TO_KT = 0.539957;
            }

            setUnit(type, value) {
                state.units[type] = value;
                Settings.save();
                app.ui.updateHUD(); // Refresh HUD
                app.ui.renderWindSidebar(); // Refresh Wind
                this.updateLegend(); // Refresh Legend
            }

            // Converter Helpers
            formatAlt(meters) {
                if (state.units.alt === 'ft') return Math.round(meters * this.M_TO_FT);
                return Math.round(meters);
            }
            
            formatSpeed(kmh) {
                if (state.units.spd === 'kt') return Math.round(kmh * this.KMH_TO_KT);
                return Math.round(kmh);
            }

            formatVario(ms) {
                if (state.units.var === 'fts') return (ms * this.M_TO_FT).toFixed(1);
                return ms.toFixed(1);
            }

            // Sync UI dropdowns
            syncUI() {
                document.getElementById('sel-alt').value = state.units.alt;
                document.getElementById('sel-spd').value = state.units.spd;
                document.getElementById('sel-var').value = state.units.var;
                this.updateLegend();
            }

            updateLegend() {
                const u = state.units.spd;
                const legU = document.getElementById('leg-u');
                const leg1 = document.getElementById('leg-1');
                const leg2 = document.getElementById('leg-2');
                const leg3 = document.getElementById('leg-3');
                const leg4 = document.getElementById('leg-4');

                if (u === 'kt') {
                    legU.innerText = 'kt';
                    leg1.innerText = '5';
                    leg2.innerText = '5-13';
                    leg3.innerText = '13-24';
                    leg4.innerText = '24';
                } else {
                    legU.innerText = 'km/h';
                    leg1.innerText = '10';
                    leg2.innerText = '10-25';
                    leg3.innerText = '25-45';
                    leg4.innerText = '45';
                }
            }
        }

        class WindManager {
            constructor() { this.generateWindProfile(state.position.lat, state.position.lng, false); }
            generateWindProfile(lat, lng, updateUI = true) {
                const baseDir = (lat + lng) % 360; 
                state.windLayers = [ { min: 0, max: 200, speed: 5, dir: baseDir, label: 'Boden' }, { min: 200, max: 500, speed: 12, dir: (baseDir + 20) % 360, label: '500m' }, { min: 500, max: 1000, speed: 25, dir: (baseDir + 45) % 360, label: '1000m' }, { min: 1000, max: 2000, speed: 35, dir: (baseDir + 90) % 360, label: '2000m' }, { min: 2000, max: 9000, speed: 55, dir: (baseDir + 120) % 360, label: 'High' } ];
                if (updateUI && typeof app !== 'undefined' && app.ui) app.ui.renderWindSidebar();
            }
            getCurrentWind(alt) { return state.windLayers.find(l => alt >= l.min && alt < l.max) || state.windLayers[state.windLayers.length - 1]; }
        }

        class BarometerManager {
            constructor() { this.available = false; this.sensor = null; this.history = []; this.vario = 0; }
            init() {
                if ('Barometer' in window) {
                    try {
                        this.sensor = new Barometer({ frequency: 10 });
                        this.sensor.addEventListener('reading', () => this.processReading());
                        this.sensor.start(); this.available = true;
                    } catch (e) { console.warn("Barometer not available"); }
                }
            }
            processReading() {
                if (!this.sensor.pressure) return;
                const alt = 44330 * (1 - Math.pow(this.sensor.pressure / 1013.25, 0.1903));
                const now = Date.now();
                this.history.push({ t: now, a: alt });
                const cutoff = now - 2000;
                this.history = this.history.filter(item => item.t > cutoff);
                const oldSample = this.history.find(item => item.t >= now - 1000);
                if (oldSample && this.history.length > 5) {
                     const dt = (now - oldSample.t) / 1000;
                     if (dt > 0.5) this.vario = (alt - oldSample.a) / dt;
                }
            }
        }

        class CompassManager {
            constructor() { this.active = false; this.heading = 0; }
            toggle() { document.getElementById('compass-toggle-check').checked ? this.start() : this.stop(); }
            start() {
                const handler = (e) => {
                    let heading = e.webkitCompassHeading || Math.abs(e.alpha - 360);
                    this.heading = heading;
                    if(this.active) app.ui.updateViewCone(heading);
                };
                this.handleOrientation = handler;
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission().then(r => {
                        if (r === 'granted') { window.addEventListener('deviceorientation', this.handleOrientation); this.active = true; app.ui.toggleViewCone(true); }
                        else { alert("Erlaubnis verweigert."); document.getElementById('compass-toggle-check').checked = false; }
                    }).catch(console.error);
                } else {
                    window.addEventListener('deviceorientationabsolute', this.handleOrientation);
                    window.addEventListener('deviceorientation', this.handleOrientation);
                    this.active = true; app.ui.toggleViewCone(true);
                }
            }
            stop() {
                window.removeEventListener('deviceorientation', this.handleOrientation);
                window.removeEventListener('deviceorientationabsolute', this.handleOrientation);
                this.active = false; app.ui.toggleViewCone(false);
            }
        }

        class Physics {
            constructor() { 
                this.burnerOn = false; 
                this.valveOpen = false; 
                this.lastUpdate = Date.now(); 
                this.loop = this.loop.bind(this);
                this.envelopeTemp = 50; 
            }
            start() { this.lastUpdate = Date.now(); requestAnimationFrame(this.loop); }
            setControls(burner, valve) { this.burnerOn = burner; this.valveOpen = valve; }
            loop() {
                const now = Date.now();
                const dt = (now - this.lastUpdate) / 1000;
                this.lastUpdate = now;

                if (state.mode === 'simulation') {
                    if (this.burnerOn) this.envelopeTemp += 30 * dt; 
                    const coolingRate = 0.5 + (this.envelopeTemp * 0.02); 
                    this.envelopeTemp -= coolingRate * dt;
                    if (this.valveOpen) this.envelopeTemp -= 40 * dt;
                    if (this.envelopeTemp < 0) this.envelopeTemp = 0; 
                    if (this.envelopeTemp > 150) this.envelopeTemp = 150; 

                    const buoyancyLift = (this.envelopeTemp - 50) * 0.15;
                    const drag = state.velocity.v * 0.3; 
                    state.velocity.v += (buoyancyLift - drag) * dt; 

                    state.position.alt += state.velocity.v * dt;
                    if (state.position.alt < 0) { state.position.alt = 0; state.velocity.v = 0; }

                    if (state.position.alt > 10) { 
                        const wind = app.wind.getCurrentWind(state.position.alt);
                        state.velocity.h = wind.speed;
                        state.velocity.heading = wind.dir;
                        const dist = (state.velocity.h / 3.6) * dt; 
                        state.position.lat += (dist * Math.cos(wind.dir * Math.PI / 180) / 6378137) * (180 / Math.PI);
                        state.position.lng += (dist * Math.sin(wind.dir * Math.PI / 180) / 6378137) * (180 / Math.PI) / Math.cos(state.position.lat * Math.PI / 180);
                    } else { state.velocity.h = 0; }
                    app.updateLocation(state.position);
                }
                requestAnimationFrame(this.loop);
            }
        }

        class UIManager {
            constructor() {
                this.map = null; this.markers = {}; this.baseLayers = {}; this.currentLayerIndex = 0; this.layerKeys = ['dark', 'light', 'sat'];
            }
            initMap() {
                if (localStorage.getItem('an_map_layer') === null && window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) this.currentLayerIndex = 1; 
                else if (localStorage.getItem('an_map_layer')) this.currentLayerIndex = parseInt(localStorage.getItem('an_map_layer'));

                this.baseLayers.dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 19 });
                this.baseLayers.light = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' });
                this.baseLayers.sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; ESRI' });

                this.map = L.map('map', { zoomControl: false, layers: [this.baseLayers[this.layerKeys[this.currentLayerIndex]]] }).setView([state.position.lat, state.position.lng], 13);
                this.updateBalloonMarker();
                this.markers.track = L.polyline([], {color: 'red', weight: 3}).addTo(this.map);
                this.markers.vector = L.polyline([], {color: 'deepskyblue', dashArray: '5, 10', weight: 2}).addTo(this.map);
                this.markers.kmlLayerGroup = L.layerGroup().addTo(this.map);
                this.markers.playbackLayer = L.layerGroup().addTo(this.map);

                this.map.on('contextmenu', (e) => this.setTarget(e.latlng));
                this.map.on('dragstart', () => { 
                    if (!state.mapLocked) {
                        state.autoFollow = false; 
                        app.ui.updateFollowButton(); 
                    }
                });
            }
            updateBalloonMarker() {
                if (this.markers.balloon) this.map.removeLayer(this.markers.balloon);
                if (this.markers.cone) this.map.removeLayer(this.markers.cone); 
                const storedIcon = localStorage.getItem('aeronav_custom_icon');
                let iconObj = storedIcon ? L.icon({ iconUrl: storedIcon, iconSize: [48, 48], iconAnchor: [24, 24], popupAnchor: [0, -24] }) : 
                                           L.divIcon({ html: '<div style="font-size: 24px; color: #ff4500; text-shadow: 0 0 10px #ff0000; transition: transform 0.5s;"><i class="fas fa-hotair-balloon"></i></div>', className: 'balloon-marker', iconSize: [24, 30], iconAnchor: [12, 30] });
                const coneIcon = L.divIcon({ className: 'hidden', html: '<div class="compass-cone"></div>', iconSize: [0,0], iconAnchor: [0, 0] });
                this.markers.cone = L.marker([state.position.lat, state.position.lng], {icon: coneIcon}).addTo(this.map);
                this.markers.balloon = L.marker([state.position.lat, state.position.lng], {icon: iconObj}).addTo(this.map);
            }
            toggleViewCone(show) { const el = document.querySelector('.compass-cone'); if(el) el.parentElement.classList.toggle('hidden', !show); }
            updateViewCone(heading) { const el = document.querySelector('.compass-cone'); if(el) el.style.transform = `rotate(${heading}deg)`; }
            loadCustomIcon(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => { localStorage.setItem('aeronav_custom_icon', e.target.result); this.updateBalloonMarker(); alert("Icon gespeichert!"); };
                reader.readAsDataURL(file);
            }
            cycleMapLayer() {
                this.map.removeLayer(this.baseLayers[this.layerKeys[this.currentLayerIndex]]);
                this.currentLayerIndex = (this.currentLayerIndex + 1) % this.layerKeys.length;
                this.map.addLayer(this.baseLayers[this.layerKeys[this.currentLayerIndex]]);
                Settings.save();
            }
            updateHUD() {
                // Convert Units
                document.getElementById('hud-alt').innerText = app.units.formatAlt(state.position.alt);
                document.getElementById('unit-alt').innerText = state.units.alt;

                document.getElementById('hud-speed').innerText = app.units.formatSpeed(state.velocity.h);
                document.getElementById('unit-speed').innerText = state.units.spd === 'kmh' ? 'km/h' : 'kt';

                document.getElementById('hud-heading').innerText = Math.round(state.velocity.heading);
                
                // Vario Logic
                let varioRaw = state.velocity.v;
                if (state.mode === 'gps' && app.barometer.available && app.barometer.vario !== 0) {
                    varioRaw = app.barometer.vario;
                }
                
                const varioVal = app.units.formatVario(varioRaw);
                const varioEl = document.getElementById('hud-vario');
                varioEl.innerText = (varioRaw > 0 ? '+' : '') + varioVal;
                document.getElementById('unit-vario').innerText = state.units.var === 'ms' ? 'm/s' : 'ft/s';

                varioEl.className = `text-3xl font-bold hud-value ${varioRaw > 0.5 ? 'text-green-400' : (varioRaw < -0.5 ? 'text-red-400' : 'text-gray-300')}`;
                
                document.getElementById('baro-indicator').classList.toggle('hidden', !(state.mode === 'gps' && app.barometer.available));
                
                const activeWind = app.wind.getCurrentWind(state.position.alt);
                document.querySelectorAll('.wind-bar-item').forEach(el => el.classList.remove('active'));
                if (document.getElementById(`wind-${activeWind.min}`)) document.getElementById(`wind-${activeWind.min}`).classList.add('active');
            }
            renderWindSidebar() {
                const container = document.getElementById('wind-layers'); container.innerHTML = '';
                [...state.windLayers].reverse().forEach(layer => {
                    const spd = app.units.formatSpeed(layer.speed);
                    const unit = state.units.spd === 'kmh' ? 'km/h' : 'kt';
                    container.innerHTML += `<div id="wind-${layer.min}" class="wind-bar-item p-2 border-b border-gray-700/50 flex flex-col justify-center h-16 transition-all"><div class="text-[10px] text-gray-400">${layer.label}</div><div class="flex items-center justify-between"><i class="fas fa-arrow-up transform text-gray-200" style="transform: rotate(${layer.dir}deg)"></i><span class="font-bold text-gray-200">${spd} <span class="text-[9px]">${unit}</span></span></div></div>`;
                });
            }
            updateMap(pos) {
                if (!this.markers.balloon) return;
                const latLng = [pos.lat, pos.lng];
                this.markers.balloon.setLatLng(latLng);
                this.markers.cone.setLatLng(latLng);
                
                // Track Logic: Every 5 seconds
                if (state.recording) {
                    const now = Date.now();
                    if (now - state.lastRecordTime > 5000) {
                        this.markers.track.addLatLng(latLng);
                        state.trackPoints.push({ 
                            lat: pos.lat, lng: pos.lng, alt: pos.alt, 
                            speed: state.velocity.h, time: new Date().toISOString() 
                        });
                        state.lastRecordTime = now;
                    }
                }

                const wind = app.wind.getCurrentWind(pos.alt);
                const dist5min = (wind.speed / 3.6) * 300; 
                const pLat = pos.lat + (dist5min * Math.cos(wind.dir * Math.PI / 180) / 6378137) * (180 / Math.PI);
                const pLng = pos.lng + (dist5min * Math.sin(wind.dir * Math.PI / 180) / 6378137) * (180 / Math.PI) / Math.cos(pos.lat * Math.PI / 180);
                this.markers.vector.setLatLngs([latLng, [pLat, pLng]]);
                
                if (state.mapLocked) {
                    this.map.panTo(latLng);
                } else if (state.mode === 'simulation' && state.autoFollow) {
                    this.map.panTo(latLng);
                }
            }
            updateFollowButton() {
                const btn = document.getElementById('btn-center');
                const icon = document.getElementById('icon-center');
                btn.className = 'glass-panel p-3 rounded-full w-12 h-12 flex items-center justify-center select-none touch-none';
                if (state.mapLocked) {
                    btn.classList.add('text-red-400', 'border', 'border-red-500/50', 'bg-red-900/20');
                    icon.className = 'fas fa-lock';
                } else if (state.autoFollow) {
                    btn.classList.add('text-blue-400', 'hover:bg-blue-900/50');
                    icon.className = 'fas fa-crosshairs';
                } else {
                    btn.classList.add('text-gray-400', 'hover:bg-gray-700');
                    icon.className = 'fas fa-crosshairs';
                }
            }
            toggleMapLock(forceState) {
                const newState = (typeof forceState !== 'undefined') ? forceState : !state.mapLocked;
                if (newState === state.mapLocked) return;
                state.mapLocked = newState;
                if (state.mapLocked) {
                    this.map.dragging.disable(); this.map.touchZoom.disable(); this.map.doubleClickZoom.disable(); this.map.scrollWheelZoom.disable(); this.map.boxZoom.disable(); this.map.keyboard.disable(); if (this.map.tap) this.map.tap.disable();
                    state.autoFollow = true; 
                } else {
                    this.map.dragging.enable(); this.map.touchZoom.enable(); this.map.doubleClickZoom.enable(); this.map.scrollWheelZoom.enable(); this.map.boxZoom.enable(); this.map.keyboard.enable(); if (this.map.tap) this.map.tap.enable();
                }
                this.updateFollowButton();
            }
            setTarget(latlng) {
                if (this.markers.target) this.map.removeLayer(this.markers.target);
                this.markers.target = L.marker(latlng, { icon: L.divIcon({html: '<i class="fas fa-flag-checkered text-yellow-400 text-2xl"></i>', className: 'target-icon'}) }).addTo(this.map);
                state.target = latlng; app.ai.suggestCourse();
            }
            updateOpacity(val) {
                const blur = Math.round(val * 12); 
                document.querySelectorAll('.glass-panel').forEach(el => {
                    el.style.backgroundColor = `rgba(15, 23, 42, ${val})`; el.style.backdropFilter = `blur(${blur}px)`; el.style.webkitBackdropFilter = `blur(${blur}px)`;
                    el.style.borderColor = `rgba(255, 255, 255, ${Math.max(0.05, val * 0.2)})`; el.style.boxShadow = val < 0.2 ? 'none' : '0 8px 32px 0 rgba(0, 0, 0, 0.37)';
                });
                Settings.save();
            }
        }

        class DataManager {
            constructor() { this.layers = []; }
            loadStoredLayers() {
                const storedJSON = localStorage.getItem('aeronav_layers_v2');
                if (storedJSON) { try { JSON.parse(storedJSON).forEach(item => this.addLayer(item.name, item.data, item.visible, false)); } catch (e) { console.error(e); } }
                this.renderLayerList();
            }
            saveLayers() {
                try { localStorage.setItem('aeronav_layers_v2', JSON.stringify(this.layers.map(l => ({ name: l.name, visible: l.visible, data: l.data })))); } catch(e) { console.warn("Storage Full"); }
                this.renderLayerList();
            }
            handleKML(file) {
                if (!file) return;
                document.getElementById('loading-overlay').classList.remove('hidden');
                const reader = new FileReader();
                reader.onload = (e) => { this.addLayer(file.name, e.target.result, true, true); document.getElementById('loading-overlay').classList.add('hidden'); };
                reader.readAsText(file);
            }
            addLayer(name, xmlString, visible, autoSave) {
                const id = Date.now() + Math.random(); const group = L.layerGroup();
                try { this.parseKMLToGroup(new DOMParser().parseFromString(xmlString, 'text/xml'), group); } catch(e) { return; }
                if (visible) group.addTo(app.ui.map);
                this.layers.push({ id, name, visible, data: xmlString, leafletGroup: group });
                if (autoSave) this.saveLayers();
            }
            toggleLayer(id) {
                const layer = this.layers.find(l => l.id == id);
                if (layer) { layer.visible = !layer.visible; layer.visible ? layer.leafletGroup.addTo(app.ui.map) : app.ui.map.removeLayer(layer.leafletGroup); this.saveLayers(); }
            }
            deleteLayer(id) {
                const index = this.layers.findIndex(l => l.id == id);
                if (index > -1) { app.ui.map.removeLayer(this.layers[index].leafletGroup); this.layers.splice(index, 1); this.saveLayers(); }
            }
            clearAllData() {
                if(confirm("Alle Daten löschen?")) {
                    this.layers.forEach(l => app.ui.map.removeLayer(l.leafletGroup)); this.layers = []; localStorage.removeItem('aeronav_layers_v2'); localStorage.removeItem('aeronav_custom_icon'); localStorage.removeItem('aeronav_flight_logs');
                    app.ui.updateBalloonMarker(); this.renderLayerList(); app.logbook.renderLogList(); alert("Daten gelöscht.");
                }
            }
            renderLayerList() {
                const container = document.getElementById('layer-list'); container.innerHTML = '';
                if (this.layers.length === 0) { container.innerHTML = '<div class="text-xs text-gray-500 text-center py-2 italic">Keine Karten geladen</div>'; return; }
                this.layers.forEach(l => {
                    container.innerHTML += `<div class="flex items-center justify-between bg-gray-800 p-2 rounded border border-gray-700"><div class="flex items-center gap-2 overflow-hidden"><input type="checkbox" ${l.visible ? 'checked' : ''} class="rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-600" onchange="app.data.toggleLayer(${l.id})"><span class="text-xs text-gray-200 truncate" title="${l.name}">${l.name}</span></div><button onclick="app.data.deleteLayer(${l.id})" class="text-gray-500 hover:text-red-400 ml-2"><i class="fas fa-trash-alt text-xs"></i></button></div>`;
                });
            }
            parseKMLToGroup(xmlDoc, group) {
                const placemarks = xmlDoc.getElementsByTagName('Placemark');
                for (let i = 0; i < placemarks.length; i++) {
                    const pm = placemarks[i]; const name = pm.getElementsByTagName('name')[0]?.textContent || 'Unbenannt'; const desc = pm.getElementsByTagName('description')[0]?.textContent || '';
                    const popupContent = `<div class="font-bold text-blue-400 mb-2 text-base border-b border-gray-600 pb-1 pr-4">${name}</div><div class="text-sm leading-relaxed max-h-60 overflow-y-auto text-gray-100 mt-1 space-y-1">${desc || '<span class="italic text-gray-400">Keine Details.</span>'}</div>`;
                    const point = pm.getElementsByTagName('Point')[0];
                    if (point) {
                        const s = point.getElementsByTagName('coordinates')[0]?.textContent.trim().split(',');
                        if(s) L.circleMarker([parseFloat(s[1]), parseFloat(s[0])], { radius: 5, color: '#ffffff', fillColor: '#3b82f6', fillOpacity: 0.9, weight: 2 }).bindPopup(popupContent, {maxWidth: 300}).addTo(group);
                    }
                    const polygon = pm.getElementsByTagName('Polygon')[0];
                    if (polygon) {
                        const s = polygon.getElementsByTagName('coordinates')[0]?.textContent.trim().split(/\s+/).map(p => [parseFloat(p.split(',')[1]), parseFloat(p.split(',')[0])]);
                        if(s.length > 0) {
                            let color = '#3b82f6', weight = 1, dash = '5, 5';
                            if (name.toUpperCase().match(/CTR|ED-R|DANGER|PROHIBITED/)) { color = '#ef4444'; weight = 2; dash = null; } else if (name.toUpperCase().match(/C |D /)) { color = '#60a5fa'; weight = 1; }
                            L.polygon(s, { color, fillColor: color, fillOpacity: 0.15, weight, dashArray: dash }).bindTooltip(name, { permanent: true, direction: 'center', className: 'airspace-label' }).bindPopup(popupContent, {maxWidth: 300}).addTo(group);
                        }
                    }
                }
            }
        }

        class AIAssistant {
            openAssistant() { document.getElementById('ai-panel').classList.remove('hidden'); }
            close() { document.getElementById('ai-panel').classList.add('hidden'); }
            async suggestCourse() {
                if (!state.target) return;
                const msgEl = document.getElementById('ai-output'); msgEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Berechne optimalen Flugpfad...';
                setTimeout(() => msgEl.innerHTML = "Kurs berechnet.", 1000);
            }
            analyzeWind() { document.getElementById('ai-output').innerText = "Analysiere lokale Orographie... (Mock)"; }
            generateLogSummary() { document.getElementById('ai-output').innerText = "Flugzusammenfassung: Ruhige Fahrt."; }
        }

        class Logbook {
            constructor() { this.logs = JSON.parse(localStorage.getItem('aeronav_flight_logs') || '[]'); }
            toggleRecording() {
                state.recording = !state.recording;
                const btn = document.getElementById('rec-status'); const btnUi = document.getElementById('btn-record'); const icon = document.getElementById('icon-record');
                if (state.recording) {
                    btn.classList.remove('hidden'); icon.classList.remove('text-gray-400'); icon.classList.add('text-red-500'); btnUi.classList.add('bg-red-900/50');
                    state.trackPoints = []; state.lastRecordTime = 0; app.ui.markers.track.setLatLngs([]);
                } else {
                    btn.classList.add('hidden'); icon.classList.add('text-gray-400'); icon.classList.remove('text-red-500'); btnUi.classList.remove('bg-red-900/50');
                    if (state.trackPoints.length > 2) this.saveFlight(state.trackPoints);
                }
            }
            saveFlight(points) {
                const now = new Date();
                const log = {
                    id: now.getTime(),
                    date: now.toLocaleString(),
                    duration: Math.round((new Date(points[points.length-1].time) - new Date(points[0].time)) / 60000) + ' min',
                    points: points
                };
                this.logs.unshift(log);
                this.save();
                alert("Flug im Logbuch gespeichert!");
                this.renderLogList();
            }
            save() { try { localStorage.setItem('aeronav_flight_logs', JSON.stringify(this.logs)); } catch(e) { alert("Logbuch voll!"); } }
            deleteLog(id) {
                if(confirm("Eintrag löschen?")) {
                    this.logs = this.logs.filter(l => l.id !== id);
                    this.save(); this.renderLogList();
                    app.ui.markers.playbackLayer.clearLayers();
                }
            }
            loadLogToMap(id) {
                const log = this.logs.find(l => l.id === id);
                if(!log) return;
                
                app.ui.markers.playbackLayer.clearLayers();
                const points = log.points;
                if(points.length < 2) return;

                // Color Coded Path
                for(let i=0; i<points.length-1; i++) {
                    const p1 = points[i];
                    const p2 = points[i+1];
                    const speed = p1.speed || 0;
                    
                    let color = '#3b82f6'; // Blue < 10
                    if(speed >= 10 && speed < 25) color = '#22c55e'; // Green
                    else if(speed >= 25 && speed < 45) color = '#f97316'; // Orange
                    else if(speed >= 45) color = '#ef4444'; // Red

                    L.polyline([[p1.lat, p1.lng], [p2.lat, p2.lng]], {color: color, weight: 5, opacity: 0.8}).addTo(app.ui.markers.playbackLayer);
                }

                // Fit bounds
                const latlngs = points.map(p => [p.lat, p.lng]);
                app.ui.map.fitBounds(L.polyline(latlngs).getBounds());
                app.toggleSettings(); 
            }
            exportGPX(id) {
                const log = this.logs.find(l => l.id === id);
                if(!log) return;
                let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="AeroNav"><trk><name>Flight ${log.date}</name><trkseg>`;
                log.points.forEach(p => { gpx += `<trkpt lat="${p.lat}" lon="${p.lng}"><ele>${p.alt}</ele><time>${p.time}</time><speed>${p.speed}</speed></trkpt>`; });
                gpx += `</trkseg></trk></gpx>`;
                const blob = new Blob([gpx], {type: 'application/gpx+xml'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `flight_${log.id}.gpx`;
                link.click();
            }
            renderLogList() {
                const container = document.getElementById('log-list'); container.innerHTML = '';
                if (this.logs.length === 0) { container.innerHTML = '<div class="text-xs text-gray-500 text-center py-2 italic">Keine Aufzeichnungen</div>'; return; }
                this.logs.forEach(l => {
                    container.innerHTML += `
                        <div class="flex items-center justify-between bg-gray-800 p-2 rounded border border-gray-700">
                            <div class="flex-1">
                                <div class="text-xs font-bold text-gray-200">${l.date}</div>
                                <div class="text-[10px] text-gray-400">Dauer: ${l.duration} | Pkt: ${l.points.length}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="app.logbook.loadLogToMap(${l.id})" class="text-purple-400 hover:text-white" title="Anzeigen"><i class="fas fa-eye"></i></button>
                                <button onclick="app.logbook.exportGPX(${l.id})" class="text-blue-400 hover:text-white" title="GPX"><i class="fas fa-download"></i></button>
                                <button onclick="app.logbook.deleteLog(${l.id})" class="text-red-400 hover:text-white" title="Löschen"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>`;
                });
            }
        }

        class App {
            constructor() {
                this.wind = new WindManager();
                this.barometer = new BarometerManager();
                this.physics = new Physics();
                this.units = new UnitManager(); // NEW
                this.ui = new UIManager();
                this.data = new DataManager();
                this.ai = new AIAssistant();
                this.logbook = new Logbook();
                this.compass = new CompassManager();
            }
            init() {
                try {
                    Settings.load();
                    this.units.syncUI(); // Update Selectors
                    this.ui.initMap();
                    this.ui.renderWindSidebar();
                    this.physics.start();
                    this.barometer.init();
                    this.data.loadStoredLayers();
                    this.logbook.renderLogList();
                    this.updateSimModeUI();
                    
                    const bB = document.getElementById('btn-burner'), bV = document.getElementById('btn-valve');
                    const sB = () => this.physics.setControls(true, false), eB = () => this.physics.setControls(false, false);
                    const sV = () => this.physics.setControls(false, true), eV = () => this.physics.setControls(false, false);
                    bB.addEventListener('mousedown', sB); bB.addEventListener('mouseup', eB); bB.addEventListener('touchstart', (e)=>{e.preventDefault();sB()}); bB.addEventListener('touchend', eB);
                    bV.addEventListener('mousedown', sV); bV.addEventListener('mouseup', eV); bV.addEventListener('touchstart', (e)=>{e.preventDefault();sV()}); bV.addEventListener('touchend', eV);

                    this.setupCenterButton();

                    if ("geolocation" in navigator) {
                        navigator.geolocation.watchPosition((pos) => {
                            if (state.mode === 'gps') {
                                state.gpsLocked = true;
                                document.getElementById('gps-status').innerText = "GPS OK";
                                document.getElementById('gps-status').className = "text-[9px] font-bold text-green-400 border border-green-700 bg-gray-800/80 px-2 py-0.5 rounded shadow";
                                state.position.lat = pos.coords.latitude; state.position.lng = pos.coords.longitude;
                                if (pos.coords.altitude) state.position.alt = pos.coords.altitude;
                                if (pos.coords.speed) state.velocity.h = pos.coords.speed * 3.6;
                                if (pos.coords.heading) state.velocity.heading = pos.coords.heading;
                                this.updateLocation(state.position);
                            }
                        }, (err) => console.warn("GPS Error"), { enableHighAccuracy: true });
                    }
                    if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost')) navigator.serviceWorker.register('./sw.js').catch(console.log);
                } catch(e) {
                    console.error("Critical Start Error", e);
                    alert("Kritischer Start-Fehler: " + e.message + "\nDie App wird zurückgesetzt.");
                    localStorage.clear();
                    window.location.reload();
                }
            }

            setupCenterButton() {
                const btn = document.getElementById('btn-center');
                let timer;
                let isLongPress = false;

                const start = (e) => {
                    if(e.type === 'touchstart') e.preventDefault(); 
                    isLongPress = false;
                    timer = setTimeout(() => {
                        isLongPress = true;
                        if (!state.mapLocked) {
                            app.ui.toggleMapLock(true); 
                            if(navigator.vibrate) navigator.vibrate(50);
                        }
                    }, 800);
                };

                const end = (e) => {
                    if(e.type === 'touchend') e.preventDefault();
                    clearTimeout(timer);
                    if (!isLongPress) {
                        if (state.mapLocked) {
                            app.ui.toggleMapLock(false); 
                        } else {
                            app.toggleFollow(); 
                        }
                    }
                };

                btn.addEventListener('mousedown', start);
                btn.addEventListener('touchstart', start);
                btn.addEventListener('mouseup', end);
                btn.addEventListener('touchend', end);
                btn.addEventListener('mouseleave', () => clearTimeout(timer));
            }

            updateLocation(pos) { this.ui.updateMap(pos); this.ui.updateHUD(); }
            toggleSimulation() { state.mode = state.mode === 'simulation' ? 'gps' : 'simulation'; this.updateSimModeUI(); Settings.save(); }
            updateSimModeUI() {
                document.getElementById('sim-toggle-check').checked = (state.mode === 'simulation');
                const simControls = document.getElementById('sim-controls'), recBtn = document.getElementById('btn-record'), status = document.getElementById('gps-status');
                if (state.mode === 'simulation') {
                    simControls.classList.remove('hidden'); recBtn.classList.add('hidden');
                    status.innerText = "SIMULATION"; status.className = "text-[9px] font-bold text-blue-400 border border-gray-700 bg-gray-800/80 px-2 py-0.5 rounded shadow";
                    if(state.recording) this.logbook.toggleRecording();
                } else {
                    simControls.classList.add('hidden'); recBtn.classList.remove('hidden');
                    status.innerText = "WAITING GPS..."; status.className = "text-[9px] font-bold text-red-400 border border-red-900 bg-red-900/30 px-2 py-0.5 rounded shadow";
                }
            }
            toggleSettings() {
                const modal = document.getElementById('settings-modal');
                modal.classList.toggle('hidden');
                if (!modal.classList.contains('hidden')) {
                   document.getElementById('api-key').value = state.apiKey;
                   document.getElementById('sim-toggle-check').checked = (state.mode === 'simulation');
                } else {
                   state.apiKey = document.getElementById('api-key').value;
                   localStorage.setItem('gemini_key', state.apiKey);
                }
            }
            toggleFollow() { state.autoFollow = !state.autoFollow; this.ui.updateFollowButton(); if (state.autoFollow) this.ui.map.panTo([state.position.lat, state.position.lng]); }
        }
        const app = new App();
        window.addEventListener('load', () => app.init());
    </script>
</body>
</html>
