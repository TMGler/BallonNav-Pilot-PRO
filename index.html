<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AeroNav Balloon Pilot</title>
    
    <!-- PWA Integration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AeroNav">

    <!-- Frameworks & Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --glass-bg: rgba(15, 23, 42, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-blue: #3b82f6;
            --accent-red: #ef4444;
            --accent-green: #22c55e;
            --accent-yellow: #eab308;
        }

        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 0;
            background: #020617;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- HUD COMMON ANIMATIONS --- */
        .hud-container-anim {
            transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1), transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- HUD TOP CONTAINER --- */
        .hud-top-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 95%;
            max-width: 800px;
            min-height: 75px; 
            display: flex;
            align-items: center; 
            padding-left: 40px; 
            pointer-events: none;
        }

        .hud-top-container.docked {
            left: 10px;
            transform: translateX(0);
            width: auto;
        }

        .hud-top {
            pointer-events: auto;
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* Time column */
            gap: 4px;
            padding: 8px;
            width: 100%;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 1;
            transform: translateX(0);
        }

        .hud-top.minimized {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-20px);
            position: absolute; 
        }

        /* Toggle Button Wrapper */
        #btn-top-toggle-wrapper {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1001;
            pointer-events: auto;
        }

        /* --- NAVIGATION HUD --- */
        .hud-nav-container {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 990;
            width: 90%;
            max-width: 600px;
            min-height: 75px; 
            display: flex;
            align-items: center;
            padding-left: 40px;
            pointer-events: none;
        }

        .hud-nav-container.docked {
            left: 10px;
            transform: translateX(0);
            width: auto;
        }

        .hud-nav {
            pointer-events: auto;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 4px;
            padding: 8px;
            border-color: var(--accent-yellow);
            border-width: 1px;
            width: 100%;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 1;
            transform: translateX(0);
        }
        
        .hud-nav.minimized {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-20px);
            position: absolute;
        }

        #btn-nav-toggle-wrapper {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 991;
            pointer-events: auto;
        }

        /* --- TOGGLE ICONS ROTATION --- */
        #icon-top-hud-toggle, 
        #icon-nav-hud-toggle, 
        #icon-wind-toggle {
            transition: transform 0.3s ease;
        }
        
        #icon-top-hud-toggle.collapsed, 
        #icon-nav-hud-toggle.collapsed, 
        #icon-wind-toggle.collapsed {
            transform: rotate(180deg);
        }

        .hud-value { text-align: center; }
        .hud-label { font-size: 0.7rem; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.05em; font-weight: 600; }
        .hud-num { font-size: 1.4rem; font-weight: 700; font-family: 'Courier New', Courier, monospace; }
        .hud-nav .hud-num { font-size: 1.2rem; color: var(--accent-yellow); }

        /* Animation for Vario Warning */
        @keyframes blink-red { 
            0%, 100% { color: #f87171; text-shadow: 0 0 5px rgba(239, 68, 68, 0.5); } 
            50% { color: #fee2e2; text-shadow: 0 0 10px rgba(239, 68, 68, 1); } 
        }
        .text-blink-red { animation: blink-red 0.8s infinite ease-in-out; }

        /* Time Display Style */
        #hud-time { font-size: 1.1rem; color: #cbd5e1; font-family: 'Inter', sans-serif; font-weight: 600; margin-top: 2px; }

        .sidebar-left { 
            position: absolute; 
            bottom: 30px; 
            left: 10px; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        
        .sidebar-right-container { 
            position: absolute; 
            top: 190px; 
            right: 10px; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            align-items: end;
            gap: 5px;
            transition: top 0.3s ease;
        }

        /* --- WIND PANEL --- */
        #wind-panel {
            width: 90px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: height 0.3s ease;
        }
        
        #wind-content-wrapper {
            transition: max-height 0.4s ease, opacity 0.3s ease;
            overflow: hidden;
            max-height: 400px;
            opacity: 1;
        }
        
        #wind-content-wrapper.collapsed {
            max-height: 0;
            opacity: 0;
            border: none;
            padding: 0;
        }

        .btn-round { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.2s; cursor: pointer; }
        .btn-round:active { transform: scale(0.9); }
        .btn-round.active { background: var(--accent-blue); color: white; }
        .btn-round.recording { background: var(--accent-red); animation: pulse 2s infinite; }
        .btn-round.locked { color: var(--accent-red); border-color: var(--accent-red); background: rgba(239, 68, 68, 0.2); }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(6px); z-index: 2000; display: none; padding: 20px; overflow-y: auto; }
        .modal-content { max-width: 1000px; margin: auto; min-height: 85vh; display: flex; flex-direction: column; }

        .tab-btn { padding: 12px 15px; border-bottom: 2px solid transparent; font-weight: 500; opacity: 0.6; white-space: nowrap; font-size: 0.9rem; }
        .tab-btn.active { border-color: var(--accent-blue); color: var(--accent-blue); opacity: 1; }

        .wind-layer { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); transition: background-color 0.3s; }
        .wind-layer.active-altitude {
            background-color: rgba(34, 197, 94, 0.3);
            border-radius: 6px;
            border: 1px solid rgba(34, 197, 94, 0.5);
        }

        .leaflet-tile { filter: brightness(0.85); }
        .satellite-layer .leaflet-tile { filter: none; }

        .compass-arrow { width: 0; height: 0; border-left: 5px solid solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid var(--accent-blue); transition: transform 0.3s; }
        .arrow-green { border-bottom-color: #4ade80 !important; }

        .balloon-marker-img { width: 44px; height: 44px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); object-fit: cover; background: #fff; }

        #report-stage { background: #0f172a; color: #f8fafc; width: 800px; padding: 30px; position: fixed; left: -9999px; top: 0; z-index: 9999; }

        /* Status Bar (Right Edge) */
        .status-area { position: absolute; top: 10px; right: 0px; display: flex; flex-direction: column; gap: 5px; align-items: flex-end; z-index: 2000; }
        .status-badge { background: rgba(15, 23, 42, 0.95); border-left: 4px solid #ccc; border-top-left-radius: 8px; border-bottom-left-radius: 8px; padding: 6px; color: white; font-size: 0.7rem; font-weight: bold; box-shadow: -2px 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 8px; cursor: pointer; width: 12px; overflow: hidden; transition: width 0.3s ease, padding 0.3s ease; white-space: nowrap; }
        .status-badge:hover, .status-badge.active { width: auto; padding: 6px 12px 6px 8px; }
        .status-badge.red { border-color: #ef4444; } .status-badge.green { border-color: #22c55e; } .status-badge.blue { border-color: #3b82f6; } .status-badge.yellow { border-color: #eab308; }

        #ai-nav-overlay { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; background: rgba(15, 23, 42, 0.95); border: 1px solid var(--accent-blue); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 12px; z-index: 1000; display: none; backdrop-filter: blur(8px); }
        #photo-overlay { position: fixed; inset: 0; z-index: 7000; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; padding: 20px; }
        #photo-overlay img { max-width: 95%; max-height: 95%; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        /* SELECTION OVERLAY */
        #selection-overlay { position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(4px); }
        .selection-box { background: #1e293b; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; width: 100%; max-width: 400px; max-height: 80vh; display: flex; flex-direction: column; shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }

        /* Form Controls */
        input, select, textarea { background: rgba(30, 41, 59, 0.5) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: white !important; border-radius: 6px; padding: 8px 12px; width: 100%; }
        input[type="color"] { padding: 0; height: 40px; }
        input:focus { border-color: var(--accent-blue) !important; outline: none; }
        label { font-size: 0.75rem; color: #94a3b8; margin-bottom: 4px; display: block; }
        .perf-grid input { padding: 4px; text-align: center; font-size: 0.8rem; }

    </style>
</head>
<body>

    <div id="map"></div>
    
    <div id="loading-overlay" class="fixed inset-0 z-[6000] bg-slate-900/95 flex flex-col items-center justify-center hidden backdrop-blur-sm">
        <div class="loader mb-4" style="width: 40px; height: 40px; border-width: 4px;"></div>
        <div class="text-white font-bold text-lg">Erstelle Bericht...</div>
        <div class="text-slate-400 text-sm">Bitte warten, Karte wird gerendert</div>
    </div>
    
    <div id="photo-overlay" onclick="this.style.display='none'">
        <img id="photo-overlay-img" src="">
    </div>
    
    <div id="selection-overlay">
        <div class="selection-box">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-slate-900/50 rounded-t-xl">
                <h3 id="sel-title" class="font-bold text-white">Auswahl</h3>
                <button onclick="document.getElementById('selection-overlay').style.display='none'" class="text-slate-400 hover:text-white px-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="sel-content" class="overflow-y-auto p-2 flex-1 space-y-1 max-h-[60vh]"></div>
        </div>
    </div>

    <!-- HUD TOP CONTAINER -->
    <div id="hud-top-container" class="hud-top-container hud-container-anim">
         <!-- Collapse Button: Links -->
        <div id="btn-top-toggle-wrapper">
            <button onclick="ui.toggleTopHUD()" class="bg-slate-800 text-slate-400 hover:text-white rounded-full w-8 h-8 flex items-center justify-center text-xs shadow border border-white/20" title="Ein/Ausblenden">
                <i class="fas fa-chevron-left transition-transform duration-300" id="icon-top-hud-toggle"></i>
            </button>
        </div>

        <div id="hud-top" class="hud-top glass-panel">
            <div class="hud-value">
                <div class="hud-label">Höhe</div>
                <div class="hud-num"><span id="hud-alt">0</span> <small class="text-xs font-normal" id="lbl-alt">m</small></div>
            </div>
            <div class="hud-value">
                <div class="hud-label">Vario</div>
                <div class="hud-num"><span id="hud-vario">0.0</span> <small class="text-xs font-normal" id="lbl-vario">m/s</small></div>
            </div>
            <div class="hud-value">
                <div class="hud-label">Speed</div>
                <div class="hud-num"><span id="hud-speed">0.0</span> <small class="text-xs font-normal" id="lbl-speed">km/h</small></div>
            </div>
            <div class="hud-value">
                <div class="hud-label">Kurs</div>
                <div class="hud-num"><span id="hud-course">360</span>°</div>
            </div>
             <!-- NEW: Time Display -->
            <div class="hud-value">
                <div class="hud-label">Zeit</div>
                <div class="hud-num" id="hud-time">--:--</div>
            </div>
        </div>
    </div>

    <!-- STATUS AREA (Right Edge) -->
    <div class="status-area">
        <div id="sb-rec" class="status-badge red hidden" onclick="this.classList.toggle('active')">
             <i class="fas fa-circle text-[8px]"></i> <span>REC</span>
        </div>
        <div id="sb-gps" class="status-badge blue" onclick="this.classList.toggle('active')">
             <i class="fas fa-satellite-dish text-[10px]"></i> <span id="sb-gps-text">NO GPS</span>
        </div>
        <div id="sb-baro" class="status-badge green hidden" onclick="this.classList.toggle('active')">
             <i class="fas fa-tachometer-alt text-[10px]"></i> <span>BARO ON</span>
        </div>
        <div id="sb-screen" class="status-badge yellow hidden" onclick="this.classList.toggle('active')">
             <i class="fas fa-sun text-[10px]"></i> <span>SCREEN ON</span>
        </div>
    </div>

    <!-- HUD NAVIGATION CONTAINER -->
    <div id="hud-nav-container" class="hud-nav-container hidden hud-container-anim">
        <!-- Collapse Button: Links -->
        <div id="btn-nav-toggle-wrapper">
            <button onclick="ui.toggleNavHUD()" class="bg-slate-800 text-slate-400 hover:text-white rounded-full w-8 h-8 flex items-center justify-center text-xs shadow border border-white/20" title="Ein/Ausblenden">
                <i class="fas fa-chevron-left transition-transform duration-300" id="icon-nav-hud-toggle"></i>
            </button>
        </div>

        <div id="hud-nav" class="hud-nav glass-panel">
            <div class="hud-value">
                <div class="hud-label">Distanz</div>
                <div class="hud-num"><span id="nav-dist">0.0</span> <small class="text-[0.6rem] font-normal" id="lbl-nav-dist">km</small></div>
            </div>
            <div class="hud-value">
                <div class="hud-label">Peilung</div>
                <div class="hud-num"><span id="nav-brg">0</span>°</div>
            </div>
            <div class="hud-value">
                <div class="hud-label">ETE</div>
                <div class="hud-num" id="nav-ete">--:--</div>
            </div>
            
            <button onclick="aiService.getNavigationAdvice()" id="btn-ai-nav" class="absolute -right-2 top-8 bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-xs shadow border border-white/20" title="KI Ratschlag"><i class="fas fa-magic"></i></button>
            <button onclick="ui.clearTarget()" class="absolute -right-2 -top-2 bg-slate-800 text-slate-400 hover:text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow border border-white/20"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <!-- AI NAV ADVICE OVERLAY -->
    <div id="ai-nav-overlay">
        <div class="flex justify-between items-start mb-2">
            <h4 class="text-blue-400 font-bold text-xs uppercase flex items-center gap-2"><i class="fas fa-robot"></i> AeroNav AI</h4>
            <button onclick="document.getElementById('ai-nav-overlay').style.display='none'" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div id="ai-nav-content" class="text-sm text-white font-mono leading-relaxed">
            Berechne Route...
        </div>
        <div class="text-[10px] text-slate-500 mt-2 text-right" id="ai-nav-time"></div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- SIDEBAR LEFT -->
    <div class="sidebar-left">
        <button id="btn-center" class="btn-round glass-panel" title="Zentrieren / Lock">
            <i class="fas fa-crosshairs"></i>
        </button>
        <button id="btn-record" class="btn-round glass-panel" title="Aufnahme (Lang drücken zum Stoppen)">
            <i class="fas fa-circle"></i>
        </button>
        
        <!-- PHOTO BUTTON -->
        <button id="btn-take-photo" class="hidden btn-round glass-panel text-white bg-blue-600 hover:bg-blue-500" title="Foto machen" onclick="flightManager.takePhoto()">
            <i class="fas fa-camera"></i>
        </button>
        
        <button id="btn-waypoint-lock" class="btn-round glass-panel text-slate-400" title="Wegpunkt sperren" onclick="ui.toggleWaypointLock()">
            <i class="fas fa-lock-open" id="icon-wp-lock"></i>
        </button>
        <button id="btn-layers" class="btn-round glass-panel" title="Ebenen">
            <i class="fas fa-layer-group"></i>
        </button>
        <div class="mt-4 flex flex-col gap-2">
            <button id="btn-settings" class="btn-round glass-panel bg-slate-800" title="Menü">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>

    <!-- SIDEBAR RIGHT (Wind) -->
    <!-- Added ID for sliding -->
    <div id="sidebar-right-container" class="sidebar-right-container">
        <!-- Collapse Button attached to panel -->
        <div id="btn-wind-toggle-wrapper">
             <button onclick="ui.toggleWindPanel()" class="bg-slate-800 text-slate-400 hover:text-white rounded-full w-8 h-8 flex items-center justify-center text-xs shadow border border-white/20" title="Wind">
                <i class="fas fa-chevron-right transition-transform duration-300" id="icon-wind-toggle"></i>
            </button>
        </div>

        <div id="wind-panel" class="glass-panel">
            <!-- Header with merged Live Button -->
            <div class="p-2 border-b border-white/10 flex justify-between items-center px-3">
                 <i class="fas fa-wind text-blue-400"></i>
                 <button onclick="event.stopPropagation(); weatherService.fetchLiveWind()" class="text-[0.65rem] text-green-400 hover:text-white flex flex-col items-center leading-none" title="Live Update">
                    <i class="fas fa-sync-alt mb-0.5"></i>Live
                 </button>
            </div>
            
            <div id="wind-content-wrapper" class="overflow-hidden transition-all duration-300">
                <!-- Removed sub-bar since live button moved up -->
                <div id="wind-layers-container" class="p-2 flex flex-col gap-1 max-h-60 overflow-y-auto scrollbar-hide">
                    <!-- Layers will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- SIMULATION PANEL -->
    <div id="sim-panel" class="absolute bottom-8 left-1/2 -translate-x-1/2 z-[2000] hidden glass-panel px-6 py-3 flex items-center gap-4 border border-white/10 shadow-2xl">
        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider border-r border-white/10 pr-3">Sim Control</div>
        <div class="flex gap-3">
            <button onclick="simulation.adjustAltitude(-50)" class="bg-red-600/90 hover:bg-red-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg transition transform active:scale-95 text-sm flex items-center gap-2">
                <i class="fas fa-arrow-down"></i> 50m
            </button>
            <button onclick="simulation.adjustAltitude(50)" class="bg-blue-600/90 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg transition transform active:scale-95 text-sm flex items-center gap-2">
                <i class="fas fa-arrow-up"></i> 50m
            </button>
        </div>
    </div>

    <!-- MAIN MODAL -->
    <div id="main-modal" class="overlay">
        <div class="modal-content glass-panel p-0 md:p-6"> <!-- Full width on mobile -->
            <div class="flex justify-between items-center mb-4 p-4 md:p-0">
                <h2 class="text-2xl font-bold flex items-center gap-2">AeroNav Control</h2>
                <button onclick="ui.closeModal()" class="text-3xl opacity-50 hover:opacity-100">&times;</button>
            </div>
            <!-- Improved Scrollable Tabs -->
            <div class="flex border-b border-white/10 mb-4 overflow-x-auto flex-wrap scrollbar-hide">
                <button class="tab-btn active shrink-0" onclick="ui.switchTab('planning')">Planung</button>
                <button class="tab-btn shrink-0" onclick="ui.switchTab('fleet')">Flotte</button>
                <button class="tab-btn shrink-0" onclick="ui.switchTab('cylinders')">Gasflaschen</button>
                <button class="tab-btn shrink-0" onclick="ui.switchTab('passengers')">Passagiere</button>
                <button class="tab-btn shrink-0" onclick="ui.switchTab('logbook')">Logbuch</button>
                <button class="tab-btn shrink-0" onclick="ui.switchTab('environment')">Wetter/Wind</button>
                <button class="tab-btn shrink-0" onclick="ui.switchTab('settings')">Einstellungen</button>
            </div>
            <div id="tab-content" class="flex-grow overflow-y-auto pr-2 p-4 md:p-0"></div>
        </div>
    </div>

    <!-- OFF-SCREEN REPORT GENERATOR STAGE -->
    <div id="report-stage"></div>

    <script>
        /**
         * STATE & CONSTANTS
         */
        const STORAGE_KEY = "AERONAV_PRO_DATA_V5";
        
        let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
            pilot: { name: "Max Mustermann", weight: 85, initialFlights: 0, initialHours: 0 }, 
            balloons: [],
            cylinders: [],
            passengers: [],
            logs: [],
            plannings: [], 
            archive: [], 
            windLayers: [
                { alt: 0, dir: 270, speed: 5 },
                { alt: 500, dir: 285, speed: 12 },
                { alt: 1000, dir: 300, speed: 18 },
                { alt: 2000, dir: 330, speed: 25 }
            ],
            measuredWindLayers: [],
            targetWaypoint: null,
            waypointLocked: false,
            settings: { 
                apiKey: "", 
                unitAlt: 'm', 
                unitSpeed: 'kmh', 
                unitVario: 'ms',
                trackColor: '#3b82f6',
                trackWidth: 4,
                mapStyle: 'dark',
                mode: 'sim', 
                activeBalloonId: null,
                windThreshold: 5,
                imageRetention: 30,
                baptismMaxWords: 15,
                useUTC: false
            }
        };

        // Migration logic
        if(!state.settings.unitVario) state.settings.unitVario = 'ms';
        if(!state.settings.trackColor) state.settings.trackColor = '#3b82f6';
        if(!state.settings.trackWidth) state.settings.trackWidth = 4;
        if(!state.settings.mapStyle) state.settings.mapStyle = 'dark';
        if(!state.settings.mode) state.settings.mode = 'sim';
        if(!state.measuredWindLayers) state.measuredWindLayers = [];
        if(state.settings.activeBalloonId === undefined) state.settings.activeBalloonId = null;
        if(!state.plannings) state.plannings = [];
        if(!state.archive) state.archive = [];
        if(state.pilot.initialFlights === undefined) state.pilot.initialFlights = 0;
        if(state.pilot.initialHours === undefined) state.pilot.initialHours = 0;
        if(state.activeWaypointId) delete state.activeWaypointId;
        if(state.targetWaypoint === undefined) state.targetWaypoint = null;
        if(state.waypointLocked === undefined) state.waypointLocked = false;
        if(state.waypoints) delete state.waypoints; 
        if(state.settings.windThreshold === undefined) state.settings.windThreshold = 5;
        if(state.settings.imageRetention === undefined) state.settings.imageRetention = 30;
        if(state.settings.baptismMaxWords === undefined) state.settings.baptismMaxWords = 15;
        if(state.settings.useUTC === undefined) state.settings.useUTC = false;

        // Passagier Migration: Split Name in Vor/Nachname wenn nötig
        state.passengers.forEach(p => {
            if (p.name && !p.firstName && !p.lastName) {
                const parts = p.name.trim().split(' ');
                if (parts.length > 1) {
                    p.lastName = parts.pop();
                    p.firstName = parts.join(' ');
                } else {
                    p.firstName = p.name;
                    p.lastName = "";
                }
            }
        });

        function saveState() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                if (ui && ui.showToast) ui.showToast("Speicher voll! Daten nicht gespeichert.", "error");
                console.error("Storage failed", e);
            }
        }

        // --- MATH HELPERS ---
        function toRad(deg) { return deg * Math.PI / 180; }
        function toDeg(rad) { return rad * 180 / Math.PI; }
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        function getBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) - Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
            const brg = toDeg(Math.atan2(y, x));
            return (brg + 360) % 360;
        }

        /**
         * WAKE LOCK MANAGER
         */
        const wakeLockManager = {
            wakeLock: null,
            isSupported() { return 'wakeLock' in navigator; },
            async request() {
                if (!this.isSupported()) return;
                try {
                    this.wakeLock = await navigator.wakeLock.request('screen');
                    document.getElementById('sb-screen').classList.remove('hidden'); 
                    this.wakeLock.addEventListener('release', () => {
                        document.getElementById('sb-screen').classList.add('hidden'); 
                    });
                } catch (err) { 
                    console.warn(`Screen Wake Lock ignored: ${err.name}, ${err.message}`);
                }
            },
            release() {
                if (this.wakeLock !== null) {
                    this.wakeLock.release().then(() => { this.wakeLock = null; });
                }
            },
            handleVisibilityChange() {
                if (this.wakeLock !== null && document.visibilityState === 'visible') { this.request(); }
            }
        };

        /**
         * BAROMETER SERVICE (Experimental)
         */
        const barometerService = {
            sensor: null,
            isAvailable: false,
            lastPressure: null,
            lastTime: null,
            vario: 0,
            
            init() {
                if ('Barometer' in window) {
                    try {
                        this.sensor = new Barometer({ frequency: 10 }); // High frequency for Vario
                        this.sensor.addEventListener('reading', () => this.handleReading());
                        this.sensor.addEventListener('error', (e) => {
                            console.warn("Barometer error", e);
                        });
                        this.sensor.start();
                        this.isAvailable = true;
                        
                        const b = document.getElementById('sb-baro');
                        if(b) b.classList.remove('hidden');
                        
                    } catch (err) {
                        console.log("Barometer not supported/allowed", err);
                    }
                }
            },
            
            handleReading() {
                const now = Date.now();
                const pressure = this.sensor.pressure; // hPa
                
                if (this.lastPressure && this.lastTime) {
                    const dt = (now - this.lastTime) / 1000;
                    if (dt > 0) {
                        // Formula: dh approx -8.43 * dp at sea level. More precise: 44330 * (1 - (p/p0)^0.1903)
                        const alt1 = 44330 * (1 - Math.pow(this.lastPressure/1013.25, 0.1903));
                        const alt2 = 44330 * (1 - Math.pow(pressure/1013.25, 0.1903));
                        
                        const instantVario = (alt2 - alt1) / dt;
                        
                        // Simple smoothing
                        this.vario = (this.vario * 0.8) + (instantVario * 0.2);
                    }
                }
                
                this.lastPressure = pressure;
                this.lastTime = now;
            }
        };

        /**
         * AI SERVICE (GEMINI)
         */
        const aiService = {
            async getNavigationAdvice() {
                if (!state.settings.apiKey) { ui.showToast("Kein API Key in Einstellungen!", "error"); return; }
                if (!state.targetWaypoint) { ui.showToast("Kein Ziel gesetzt!", "error"); return; }

                const overlay = document.getElementById('ai-nav-overlay');
                const content = document.getElementById('ai-nav-content');
                const time = document.getElementById('ai-nav-time');
                
                overlay.style.display = 'block';
                content.innerHTML = '<div class="loader"></div> Berechne Wind-Vektoren...';

                // Construct Prompt Data
                const currentPos = { lat: simulation.lat, lng: simulation.lng, alt: simulation.alt };
                const target = state.targetWaypoint;
                const bearingToTarget = getBearing(currentPos.lat, currentPos.lng, target.lat, target.lng);
                const distanceToTarget = getDistance(currentPos.lat, currentPos.lng, target.lat, target.lng);
                
                // Prioritize Measured Winds
                const winds = [...state.windLayers];
                state.measuredWindLayers.forEach(m => {
                    const idx = winds.findIndex(w => Math.abs(w.alt - m.alt) < 25);
                    if (idx >= 0) winds[idx] = m; else winds.push(m);
                });
                
                const promptText = `
                    Du bist Co-Pilot in einem Heißluftballon. Gib eine kurze, präzise Anweisung an den Piloten.
                    
                    Aktuelle Lage:
                    - Position: ${currentPos.lat.toFixed(4)}, ${currentPos.lng.toFixed(4)}
                    - Höhe: ${Math.round(currentPos.alt)}m
                    - Ziel-Peilung (Soll-Kurs): ${Math.round(bearingToTarget)}°
                    - Distanz zum Ziel: ${distanceToTarget.toFixed(1)} km
                    
                    Verfügbare Windschichten (Höhe -> Richtung):
                    ${winds.sort((a,b)=>a.alt-b.alt).map(w => `- ${w.alt}m: ${w.dir}°`).join('\n')}
                    
                    Aufgabe:
                    Welche Höhe ist am besten, um dem Zielkurs (${Math.round(bearingToTarget)}°) am nächsten zu kommen?
                    Antworte extrem kurz (max 15 Wörter) im Format: "Steige/Sinke auf X m (Wind Y°)." oder "Bleibe auf aktueller Höhe."
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.settings.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                    });
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Keine Antwort.";
                    
                    content.innerHTML = text;
                    time.innerText = "Stand: " + new Date().toLocaleTimeString();

                } catch (e) {
                    content.innerText = "Fehler bei AI Anfrage.";
                    console.error(e);
                }
            },

            async getBaptismSuggestions(paxName, startLoc, endLoc, time, notes, btn) {
                if (!state.settings.apiKey) { ui.showToast("Kein API Key in Einstellungen!", "error"); return; }
                
                btn.innerHTML = '<div class="loader inline-block w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';
                
                const maxWords = state.settings.baptismMaxWords || 15;
                const promptText = `
                    Generiere 5 kreative und lustige Ballonfahrertaufnamen (Adelstitel) für einen Passagier.
                    Erwähne den Vornamen: ${paxName}.
                    Inkorporiere Elemente aus:
                    1. Startort (${startLoc}) ODER Landeort (${endLoc}).
                    2. Der Tageszeit (${time}).
                    3. Dem folgenden Ereignis/Notiz: ${notes} (Falls leer, ignoriere dies).
                    
                    Regeln:
                    - Die Titel müssen auf Deutsch sein.
                    - Jeder Titel darf maximal ${maxWords} Wörter lang sein.
                    - Format: Nur die 5 Titel, getrennt durch ein Semikolon (;). Keine Nummerierung, keine Anführungszeichen.
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.settings.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                    });
                    
                    const result = await response.json();
                    let text = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    
                    // Clean up potential formatting
                    text = text.replace(/\n/g, '').trim();
                    const suggestions = text.split(';').map(s => s.trim()).filter(s => s.length > 0);
                    
                    return suggestions;

                } catch (e) {
                    ui.showToast("Fehler bei AI Anfrage.", "error");
                    console.error(e);
                    return [];
                } finally {
                    btn.innerHTML = '<i class="fas fa-magic"></i>';
                }
            }
        };

        /**
         * ENGINE: SIMULATION & PHYSICS
         */
        const simulation = {
            gpsWatchId: null,
            lastGpsTime: null,
            lastGpsAlt: null,
            
            lat: 51.1657, lng: 10.4515, alt: 200, targetAlt: 200,
            course: 270, speed: 5, vario: 0,

            init() {
                document.addEventListener('visibilitychange', () => wakeLockManager.handleVisibilityChange());
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        this.lat = pos.coords.latitude;
                        this.lng = pos.coords.longitude;
                        if(mapManager.map) {
                            mapManager.map.setView([this.lat, this.lng], 14);
                            flightManager.updateHUD(this.getCurrentState()); 
                        }
                    }, () => {});
                }
                
                barometerService.init();
                
                setInterval(() => this.tick(), 1000);
                this.applyMode();
            },

            applyMode() {
                const mode = state.settings.mode;
                const simPanel = document.getElementById('sim-panel');
                const badgeGPS = document.getElementById('sb-gps');
                const badgeGPSText = document.getElementById('sb-gps-text');

                // Safety check
                if (!simPanel || !badgeGPS) return;

                if (mode === 'gps') {
                    simPanel.classList.add('hidden'); 
                    badgeGPS.classList.remove('hidden');
                    badgeGPS.classList.remove('blue', 'green'); 
                    badgeGPS.classList.add('red');
                    if(badgeGPSText) badgeGPSText.innerText = "NO GPS";
                    this.startGPS();
                } else {
                    simPanel.classList.remove('hidden');
                    badgeGPS.classList.remove('hidden');
                    if(badgeGPSText) badgeGPSText.innerText = "SIMULATION";
                    badgeGPS.classList.remove('red', 'green');
                    badgeGPS.classList.add('blue');
                    this.stopGPS();
                }
            },

            startGPS() {
                wakeLockManager.request();
                const badgeGPS = document.getElementById('sb-gps');
                const badgeGPSText = document.getElementById('sb-gps-text');
                
                if (navigator.geolocation) {
                    if (this.gpsWatchId) navigator.geolocation.clearWatch(this.gpsWatchId);
                    
                    this.gpsWatchId = navigator.geolocation.watchPosition(pos => {
                        const c = pos.coords;
                        const now = Date.now();
                        
                        if(badgeGPSText) badgeGPSText.innerText = "GPS OK";
                        badgeGPS.classList.remove('red', 'blue');
                        badgeGPS.classList.add('green');
                        
                        this.lat = c.latitude;
                        this.lng = c.longitude;
                        
                        // Calculate Vario if Barometer not available
                        if (c.altitude !== null) {
                            if (barometerService.isAvailable) {
                                // Use Barometer vario if available
                                this.vario = barometerService.vario;
                                this.alt = c.altitude; 
                            } else {
                                // Fallback GPS Vario
                                if (this.lastGpsTime && this.lastGpsAlt !== null) {
                                    const dt = (now - this.lastGpsTime) / 1000;
                                    if (dt > 0) {
                                        const instantVario = (c.altitude - this.lastGpsAlt) / dt;
                                        // Simple low pass filter
                                        this.vario = (this.vario * 0.7) + (instantVario * 0.3);
                                    }
                                }
                                this.alt = c.altitude;
                                this.lastGpsAlt = c.altitude;
                                this.lastGpsTime = now;
                            }
                        }

                        this.speed = (c.speed || 0) * 1.94384; 
                        if(c.heading !== null && !isNaN(c.heading)) this.course = c.heading;
                        
                        flightManager.updateHUD(this.getCurrentState());
                        
                    }, err => {
                        console.warn("GPS Fehler:", err.message);
                        if(badgeGPSText) badgeGPSText.innerText = "NO GPS";
                        badgeGPS.classList.remove('green', 'blue');
                        badgeGPS.classList.add('red');
                        ui.showToast("GPS Signal verloren", "error");
                    }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
                } else {
                    if(badgeGPSText) badgeGPSText.innerText = "NO SUPP";
                    badgeGPS.classList.remove('green', 'blue');
                    badgeGPS.classList.add('red');
                }
            },

            stopGPS() {
                if (this.gpsWatchId) {
                    navigator.geolocation.clearWatch(this.gpsWatchId);
                    this.gpsWatchId = null;
                }
                if (!flightManager.recording) { wakeLockManager.release(); }
            },

            adjustAltitude(delta) { this.targetAlt += delta; if (this.targetAlt < 0) this.targetAlt = 0; },

            tick() {
                if (state.settings.mode === 'gps') return;
                const diff = this.targetAlt - this.alt;
                this.vario = diff * 0.08;
                this.alt += this.vario;
                const wind = this.getWindAtAlt(this.alt);
                
                // Wind blows TO direction (From + 180)
                this.course = (wind.dir + 180) % 360;
                this.speed = wind.speed; 
                
                const moveScale = this.speed * 0.000005;
                
                // Standard Compass to Trig: 
                // 0 deg (N) -> dy+, dx0. cos(0)=1, sin(0)=0.
                // 90 deg (E) -> dy0, dx+. cos(90)=0, sin(90)=1.
                this.lat += Math.cos(toRad(this.course)) * moveScale;
                this.lng += Math.sin(toRad(this.course)) * moveScale;

                flightManager.updateHUD(this.getCurrentState());
            },

            getWindAtAlt(altitude) {
                const sorted = [...state.windLayers].sort((a,b) => a.alt - b.alt);
                let lower = sorted[0], upper = sorted[sorted.length-1];
                for (let i = 0; i < sorted.length - 1; i++) {
                    if (altitude >= sorted[i].alt && altitude <= sorted[i+1].alt) {
                        lower = sorted[i]; upper = sorted[i+1]; break;
                    }
                }
                const factor = upper.alt === lower.alt ? 0 : (altitude - lower.alt) / (upper.alt - lower.alt);
                return {
                    dir: lower.dir + (upper.dir - lower.dir) * factor,
                    speed: lower.speed + (upper.speed - lower.speed) * factor
                };
            },

            getCurrentState() { return { lat: this.lat, lng: this.lng, alt: this.alt, course: this.course, speed: this.speed, vario: this.vario }; }
        };

        const weatherService = {
            async fetchLiveWind() {
                const center = mapManager.map.getCenter();
                const lat = center.lat;
                const lng = center.lng;
                document.getElementById('wind-layers-container').innerHTML = '<div class="text-center p-2"><div class="loader"></div></div>';
                try {
                    // Changed to include &models=best_match
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=wind_speed_10m,wind_direction_10m&hourly=wind_speed_1000hPa,wind_direction_1000hPa,wind_speed_950hPa,wind_direction_950hPa,wind_speed_850hPa,wind_direction_850hPa,wind_speed_700hPa,wind_direction_700hPa&wind_speed_unit=kn&models=best_match`;
                    const response = await fetch(url);
                    const data = await response.json();
                    if (!data.hourly) throw new Error("Keine Daten");
                    const now = new Date();
                    const currentHourIso = now.toISOString().slice(0, 13) + ":00";
                    const hourIndex = data.hourly.time.findIndex(t => t.startsWith(currentHourIso)) || 0;
                    const newLayers = [
                        { alt: 0, dir: data.current.wind_direction_10m, speed: data.current.wind_speed_10m },
                        { alt: 100, dir: data.hourly.wind_direction_1000hPa[hourIndex], speed: data.hourly.wind_speed_1000hPa[hourIndex] },
                        { alt: 500, dir: data.hourly.wind_direction_950hPa[hourIndex], speed: data.hourly.wind_speed_950hPa[hourIndex] },
                        { alt: 1500, dir: data.hourly.wind_direction_850hPa[hourIndex], speed: data.hourly.wind_speed_850hPa[hourIndex] },
                        { alt: 3000, dir: data.hourly.wind_direction_700hPa[hourIndex], speed: data.hourly.wind_speed_700hPa[hourIndex] }
                    ];
                    state.windLayers = newLayers;
                    saveState();
                    ui.renderWind();
                    ui.showToast(`Live-Winddaten für ${lat.toFixed(2)}, ${lng.toFixed(2)} geladen!`, 'success');
                    if (ui.tab === 'environment') ui.render();
                } catch (e) {
                    ui.showToast("Fehler beim Laden der Wetterdaten: " + e.message, 'error');
                    ui.renderWind(); 
                }
            }
        };

        const mapManager = {
            map: null, marker: null, track: null, lock: false, targetLayer: null, navLine: null,
            layers: {
                dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'),
                light: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
            },
            init() {
                this.map = L.map('map', { zoomControl: false }).setView([51.1657, 10.4515], 13);
                const style = state.settings.mapStyle || 'dark';
                this.setLayer(style);
                
                this.updateIcon();
                
                this.track = L.polyline([], { color: state.settings.trackColor, weight: state.settings.trackWidth }).addTo(this.map);
                
                this.targetLayer = L.layerGroup().addTo(this.map);
                this.navLine = L.polyline([], { color: '#eab308', weight: 2, dashArray: '5, 10' }).addTo(this.map); 
                this.renderTarget();
                
                this.map.on('contextmenu', (e) => ui.setTarget(e.latlng));
                
                document.getElementById('btn-center').onclick = () => { this.lock = !this.lock; document.getElementById('btn-center').classList.toggle('active', this.lock); };
                document.getElementById('btn-layers').onclick = () => this.cycle();
                
                ui.updateLockBtn();

                setTimeout(() => this.map.invalidateSize(), 500);
            },
            update(pos) {
                this.marker.setLatLng([pos.lat, pos.lng]);
                if (this.lock) this.map.panTo([pos.lat, pos.lng]);
                
                if (state.targetWaypoint) {
                    this.navLine.setLatLngs([[pos.lat, pos.lng], [state.targetWaypoint.lat, state.targetWaypoint.lng]]);
                } else {
                    this.navLine.setLatLngs([]);
                }

                if (flightManager.recording) {
                    // STORE ALTITUDE IN TRACK
                    flightManager.points.push([pos.lat, pos.lng, pos.alt]);
                    this.track.setLatLngs(flightManager.points);
                }
            },
            updateTrackStyle() {
                if(this.track) {
                    this.track.setStyle({ color: state.settings.trackColor, weight: state.settings.trackWidth });
                }
            },
            updateIcon() {
                let iconHtml = '<div class="text-3xl">🎈</div>';
                let className = '';
                
                let balloonIdToUse = state.settings.activeBalloonId;
                
                // --- NEW LOGIC: Use Plan Balloon if active ---
                if (flightManager.recording && flightManager.currentActivePlan) {
                    balloonIdToUse = flightManager.currentActivePlan.balloonId;
                }

                if (balloonIdToUse) {
                    const balloon = state.balloons.find(b => b.id === balloonIdToUse);
                    if (balloon && balloon.image) {
                        iconHtml = `<img src="${balloon.image}" class="balloon-marker-img">`;
                        className = ''; 
                    }
                }
                const newIcon = L.divIcon({ html: iconHtml, className: className, iconSize: [44, 44], iconAnchor: [22, 22] });
                if (this.marker) { this.marker.setIcon(newIcon); } else { this.marker = L.marker([51.1657, 10.4515], { icon: newIcon }).addTo(this.map); }
            },
            setLayer(style) {
                if (this.map.hasLayer(this.layers.dark)) this.map.removeLayer(this.layers.dark);
                if (this.map.hasLayer(this.layers.light)) this.map.removeLayer(this.layers.light);
                if (this.map.hasLayer(this.layers.sat)) this.map.removeLayer(this.layers.sat);
                const m = document.getElementById('map');
                m.classList.remove('satellite-layer');
                if (style === 'light') { this.layers.light.addTo(this.map); } 
                else if (style === 'sat') { this.layers.sat.addTo(this.map); m.classList.add('satellite-layer'); } 
                else { this.layers.dark.addTo(this.map); }
                state.settings.mapStyle = style;
                saveState();
            },
            cycle() {
                if (state.settings.mapStyle === 'dark') this.setLayer('light');
                else if (state.settings.mapStyle === 'light') this.setLayer('sat');
                else this.setLayer('dark');
                if (ui.tab === 'settings' && document.getElementById('set-map-style')) {
                    document.getElementById('set-map-style').value = state.settings.mapStyle;
                }
            },
            renderTarget() {
                this.targetLayer.clearLayers();
                if (state.targetWaypoint) {
                    const marker = L.marker([state.targetWaypoint.lat, state.targetWaypoint.lng], {
                        icon: L.divIcon({ 
                            html: '<i class="fas fa-map-marker-alt text-yellow-500 text-3xl drop-shadow-md"></i>', 
                            className: 'bg-transparent',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        })
                    });
                    
                    marker.bindPopup(`
                        <div class="text-slate-900 text-sm text-center font-bold">
                            <button onclick="ui.clearTarget()" class="text-red-600 hover:text-red-800 text-xs">Ziel Löschen</button>
                        </div>
                    `);
                    this.targetLayer.addLayer(marker);
                }
            }
        };

        const flightManager = {
            recording: false, points: [], start: null, currentActivePlan: null, currentPhotos: [],
            maxSpeed: 0, maxAlt: 0,
            init() { 
                const btn = document.getElementById('btn-record');
                let pressTimer;
                let longPressTriggered = false;

                btn.addEventListener('click', (e) => {
                    if (longPressTriggered) {
                        longPressTriggered = false;
                        return;
                    }
                    if (!this.recording) {
                        ui.showStartDialog();
                    } else {
                        ui.showToast("Zum Stoppen 1.5 Sek. gedrückt halten", "error");
                    }
                });

                const start = (e) => {
                    if (!this.recording) return;
                    if (e.type === 'mousedown' && e.button !== 0) return;
                    
                    longPressTriggered = false;
                    pressTimer = setTimeout(() => {
                        longPressTriggered = true;
                        this.stopRecording();
                        if (navigator.vibrate) navigator.vibrate(500);
                    }, 1500); 
                };

                const cancel = () => { clearTimeout(pressTimer); };

                btn.addEventListener('mousedown', start);
                btn.addEventListener('touchstart', start, {passive: true});
                
                btn.addEventListener('mouseup', cancel);
                btn.addEventListener('mouseleave', cancel);
                btn.addEventListener('touchend', cancel);

                // Auto-cleanup on init
                this.cleanOldPhotos();
            },
            
            toggle() { },

            takePhoto() { document.getElementById('cam-input').click(); },

            handlePhotoInput(input) {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Image Resizing Logic
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Max dimensions
                            const MAX_SIZE = 800; 
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > height) {
                                if (width > MAX_SIZE) {
                                    height *= MAX_SIZE / width;
                                    width = MAX_SIZE;
                                }
                            } else {
                                if (height > MAX_SIZE) {
                                    width *= MAX_SIZE / height;
                                    height = MAX_SIZE;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Compress to JPEG 60%
                            const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.6); 
                            
                            this.currentPhotos.push({
                                time: new Date().toISOString(),
                                src: compressedDataUrl,
                                lat: simulation.lat,
                                lng: simulation.lng
                            });
                            ui.showToast("Foto gespeichert (komprimiert)!", "success");
                            
                            // Try save to catch quota errors early
                            saveState();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },
            
            cleanOldPhotos() {
                const days = state.settings.imageRetention || 30;
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - days);
                
                let cleanedCount = 0;
                state.logs.forEach(log => {
                    if (log.photos && log.photos.length > 0) {
                        const originalLen = log.photos.length;
                        log.photos = log.photos.filter(p => new Date(p.time) > cutoff);
                        cleanedCount += (originalLen - log.photos.length);
                    }
                });
                
                if(cleanedCount > 0) {
                    saveState();
                    console.log(`Cleaned ${cleanedCount} old photos.`);
                    ui.showToast(`${cleanedCount} alte Fotos bereinigt`, 'success');
                }
            },
            
            cleanOldPhotosNow() {
                this.cleanOldPhotos();
                ui.showToast("Bereinigung durchgeführt.", "success");
            },

            startRecording(planId, balloonId) {
                wakeLockManager.request();
                
                let plan = null;
                if (planId) {
                    plan = state.plannings.find(p => p.id == planId) || state.archive.find(p => p.id == planId);
                }
                
                // Handle Explicit Balloon Selection
                if (!plan && balloonId) {
                    const b = state.balloons.find(x => x.id === balloonId);
                    this.currentActivePlan = {
                        id: null, 
                        name: "Spontanfahrt",
                        balloonId: balloonId,
                        balloonName: b ? b.callsign : "Unbekannt",
                        passengers: [], 
                        cylinders: []
                    };
                } else {
                    this.currentActivePlan = plan;
                }
                
                this.currentPhotos = []; 
                this.maxSpeed = 0;
                this.maxAlt = 0;
                
                state.measuredWindLayers = [];
                ui.renderWind(); 
                this.points = [];
                mapManager.track.setLatLngs([]);
                
                this.recording = true; 
                this.start = new Date();
                
                document.getElementById('btn-record').classList.add('recording');
                document.getElementById('sb-rec').classList.remove('hidden');
                document.getElementById('btn-take-photo').classList.remove('hidden');
                
                ui.closeModal();
                
                // Force Icon Update (Added to update balloon icon based on plan)
                mapManager.updateIcon();
            },

            async stopRecording() {
                if (state.settings.mode !== 'gps') {
                    wakeLockManager.release();
                }

                const end = new Date();
                
                // Use balloon from active context
                let balloonName = "Spontan";
                if (this.currentActivePlan && this.currentActivePlan.balloonName) {
                    balloonName = this.currentActivePlan.balloonName;
                } else {
                     const defB = state.balloons.find(b => b.id === state.settings.activeBalloonId);
                     if(defB) balloonName = defB.callsign;
                }

                const currentPaxIds = this.currentActivePlan ? this.currentActivePlan.passengers : [];
                
                if (currentPaxIds.length > 0) {
                    currentPaxIds.forEach(pid => {
                        const p = state.passengers.find(px => px.id == pid);
                        if (p) {
                            p.flights = (p.flights || 0) + 1;
                            p.lastFlight = new Date().toISOString();
                        }
                    });
                }

                let startLoc = "Unbekannt";
                let endLoc = "Unbekannt";
                
                if (this.points.length > 0) {
                    try {
                        const startPt = this.points[0];
                        const endPt = this.points[this.points.length-1];
                        const getPlaceName = (data) => {
                            if (!data || !data.address) return data.display_name ? data.display_name.split(',')[0] : "Unbekannter Ort";
                            return data.address.city || data.address.town || data.address.village || data.address.hamlet || data.address.municipality || data.address.suburb || (data.display_name ? data.display_name.split(',')[0] : "Unbekannter Ort");
                        };

                        const r1 = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${startPt[0]}&lon=${startPt[1]}`);
                        const d1 = await r1.json();
                        startLoc = getPlaceName(d1);

                        const r2 = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${endPt[0]}&lon=${endPt[1]}`);
                        const d2 = await r2.json();
                        endLoc = getPlaceName(d2);
                    } catch(e) { console.warn("Reverse Geo failed", e); }
                }

                const newLog = { 
                    id: Date.now(), 
                    start: this.start.toISOString(), 
                    end: end.toISOString(), 
                    track: this.points, 
                    balloon: balloonName,
                    notes: "", 
                    startLoc: startLoc, 
                    endLoc: endLoc,     
                    planId: this.currentActivePlan ? this.currentActivePlan.id : null,
                    pax: currentPaxIds,
                    cylinders: this.currentActivePlan ? this.currentActivePlan.cylinders : [],
                    photos: this.currentPhotos,
                    maxSpeed: this.maxSpeed,
                    maxAlt: this.maxAlt
                };
                
                state.logs.push(newLog);
                saveState();
                
                this.recording = false;
                
                // Clear active plan
                this.currentActivePlan = null;
                
                document.getElementById('btn-record').classList.remove('recording');
                document.getElementById('sb-rec').classList.add('hidden');
                document.getElementById('btn-take-photo').classList.add('hidden');
                
                // Reset Icon
                mapManager.updateIcon();
                
                ui.showSummary(newLog);
            },

            updateHUD(data) {
                let dAlt = data.alt;
                let dSpeed = data.speed; // kt
                let dVario = data.vario; // m/s
                let uAlt = 'm';
                let uSpeed = 'kt';
                let uVario = 'm/s';

                if (state.settings.unitAlt === 'ft') { dAlt = data.alt * 3.28084; uAlt = 'ft'; }
                if (state.settings.unitSpeed === 'kmh') { dSpeed = data.speed * 1.852; uSpeed = 'km/h'; } else { uSpeed = 'kt'; }
                if (state.settings.unitVario === 'fts') { dVario = data.vario * 3.28084; uVario = 'ft/s'; }

                document.getElementById('hud-alt').innerText = Math.round(dAlt);
                document.getElementById('lbl-alt').innerText = uAlt;
                document.getElementById('hud-speed').innerText = dSpeed.toFixed(1);
                document.getElementById('lbl-speed').innerText = uSpeed;
                document.getElementById('hud-course').innerText = Math.round(data.course);
                
                const varioValEl = document.getElementById('hud-vario');
                const varioLblEl = document.getElementById('lbl-vario');
                varioValEl.innerText = dVario.toFixed(1);
                varioLblEl.innerText = uVario;
                varioValEl.className = 'hud-num'; // Reset classes

                // Vario Limits Check
                let currentBalloon = null;
                let balloonIdToUse = state.settings.activeBalloonId;
                if (this.recording && this.currentActivePlan) {
                     balloonIdToUse = this.currentActivePlan.balloonId;
                }
                if (balloonIdToUse) {
                    currentBalloon = state.balloons.find(b => b.id === balloonIdToUse);
                }

                // Check limits (using internal m/s values for physics consistency)
                if (currentBalloon) {
                    const maxClimb = currentBalloon.maxClimb || 5;
                    const maxDescent = currentBalloon.maxDescent || 3;
                    
                    if (data.vario > maxClimb || data.vario < -maxDescent) {
                         varioValEl.classList.add('text-blink-red');
                         varioLblEl.classList.add('text-blink-red');
                    } else if (data.vario >= 0.1) { 
                        varioValEl.classList.add('text-green-400'); varioLblEl.classList.add('text-green-400'); 
                    } else if (data.vario <= -0.1) { 
                        varioValEl.classList.add('text-red-400'); varioLblEl.classList.add('text-red-400'); 
                    }
                }
                
                // Update Time Display if Recording
                const timeEl = document.getElementById('hud-time');
                if (this.recording && this.start) {
                    const now = new Date();
                    const diffMs = now - this.start;
                    const h = Math.floor(diffMs / 3600000);
                    const m = Math.floor((diffMs % 3600000) / 60000);
                    timeEl.innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                } else {
                    timeEl.innerText = "--:--";
                }
                
                if (this.recording && data.speed > 1) { 
                    const bucketAlt = Math.round(data.alt / 50) * 50;
                    const existingIdx = state.measuredWindLayers.findIndex(l => l.alt === bucketAlt);
                    const newLayer = { alt: bucketAlt, dir: data.course, speed: data.speed, isMeasured: true };
                    if (existingIdx >= 0) { state.measuredWindLayers[existingIdx] = newLayer; } else { state.measuredWindLayers.push(newLayer); }
                    ui.renderWind();

                    // Update Max Stats
                    if (data.alt > this.maxAlt) this.maxAlt = data.alt;
                    let currentSpeedKmh = data.speed * 1.852;
                    if (currentSpeedKmh > this.maxSpeed) this.maxSpeed = currentSpeedKmh;
                }

                // Update Active Wind Layer Highlight in DOM
                const windRows = document.querySelectorAll('.wind-layer');
                windRows.forEach(row => {
                    const rowAlt = parseInt(row.dataset.alt);
                    if (Math.abs(rowAlt - data.alt) < 25) {
                        row.classList.add('active-altitude');
                    } else {
                        row.classList.remove('active-altitude');
                    }
                });

                if (state.targetWaypoint) {
                    const wp = state.targetWaypoint;
                    const distKm = getDistance(simulation.lat, simulation.lng, wp.lat, wp.lng);
                    const bearing = getBearing(simulation.lat, simulation.lng, wp.lat, wp.lng);
                    document.getElementById('hud-nav-container').classList.remove('hidden'); 
                    
                    document.getElementById('nav-brg').innerText = Math.round(bearing);
                    if (state.settings.unitAlt === 'ft') { 
                        const distNm = distKm * 0.539957;
                        document.getElementById('nav-dist').innerText = distNm.toFixed(1);
                        document.getElementById('lbl-nav-dist').innerText = 'NM';
                        if (data.speed > 1) {
                            const hours = distNm / data.speed;
                            const mins = Math.round(hours * 60);
                            document.getElementById('nav-ete').innerText = mins + " min";
                        } else { document.getElementById('nav-ete').innerText = "--:--"; }
                    } else {
                        document.getElementById('nav-dist').innerText = distKm.toFixed(1);
                        document.getElementById('lbl-nav-dist').innerText = 'km';
                        const speedKmh = data.speed * 1.852;
                        if (speedKmh > 1) {
                            const hours = distKm / speedKmh;
                            const mins = Math.round(hours * 60);
                            document.getElementById('nav-ete').innerText = mins + " min";
                        } else { document.getElementById('nav-ete').innerText = "--:--"; }
                    }
                } else {
                    document.getElementById('hud-nav-container').classList.add('hidden');
                }

                mapManager.update(data);
            }
        };

        const ui = {
            tab: 'planning', editingId: null, editingPlanId: null, planningMode: 'active', passengerMode: 'active', toastTimeout: null,
            init() { document.getElementById('btn-settings').onclick = () => this.openModal(); this.renderWind(); this.updateLockBtn(); },
            
            formatTime(isoString) {
                const date = new Date(isoString);
                if (state.settings.useUTC) {
                    const h = date.getUTCHours().toString().padStart(2, '0');
                    const m = date.getUTCMinutes().toString().padStart(2, '0');
                    return `${h}:${m} (UTC)`;
                }
                return date.toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'});
            },

            showToast(msg, type = 'success') {
                let t = document.getElementById('toast-msg'); if(!t) { const container = document.getElementById('toast-container'); t = document.createElement('div'); t.id = 'toast-msg'; t.className = 'toast-notification'; container.appendChild(t); }
                let icon = type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-check-circle"></i>'; t.innerHTML = `${icon} <span>${msg}</span>`; t.className = 'toast-notification visible ' + (type === 'error' ? 'error' : ''); if(this.toastTimeout) clearTimeout(this.toastTimeout); this.toastTimeout = setTimeout(() => { t.classList.remove('visible'); }, 3000);
            },
            
            toggleWindPanel() {
                const wrapper = document.getElementById('wind-content-wrapper');
                const chevron = document.getElementById('icon-wind-toggle'); 
                if (wrapper) wrapper.classList.toggle('collapsed');
                if (chevron) chevron.classList.toggle('collapsed');
            },
            
            toggleTopHUD() {
                const hud = document.getElementById('hud-top');
                const btnIcon = document.getElementById('icon-top-hud-toggle');
                const container = document.getElementById('hud-top-container');
                
                hud.classList.toggle('minimized');
                container.classList.toggle('docked');
                
                // Rotation logic handled via CSS class 'collapsed'
                btnIcon.classList.toggle('collapsed', hud.classList.contains('minimized'));
            },

            toggleNavHUD() {
                const nav = document.getElementById('hud-nav');
                const btnIcon = document.getElementById('icon-nav-hud-toggle');
                const container = document.getElementById('hud-nav-container');

                nav.classList.toggle('minimized'); 
                container.classList.toggle('docked');
                
                // Rotation logic handled via CSS class 'collapsed'
                btnIcon.classList.toggle('collapsed', nav.classList.contains('minimized'));
            },
            
            toggleWaypointLock() { state.waypointLocked = !state.waypointLocked; saveState(); this.updateLockBtn(); this.showToast(state.waypointLocked ? "Wegpunkt gesperrt" : "Wegpunkt entsperrt"); },
            updateLockBtn() { const btn = document.getElementById('btn-waypoint-lock'); const icon = document.getElementById('icon-wp-lock'); if (state.waypointLocked) { btn.classList.add('locked'); icon.className = 'fas fa-lock'; } else { btn.classList.remove('locked'); icon.className = 'fas fa-lock-open'; } },
            setTarget(latlng) { if (state.waypointLocked) { this.showToast("Wegpunkt ist gesperrt!", "error"); return; } state.targetWaypoint = { lat: latlng.lat, lng: latlng.lng }; saveState(); mapManager.renderTarget(); this.showToast("Ziel gesetzt", "success"); flightManager.updateHUD(simulation.getCurrentState()); document.getElementById('btn-nav-toggle-wrapper').classList.remove('hidden'); },
            clearTarget() { if (state.waypointLocked) { this.showToast("Wegpunkt ist gesperrt!", "error"); return; } state.targetWaypoint = null; saveState(); mapManager.renderTarget(); document.getElementById('hud-nav-container').classList.add('hidden'); document.getElementById('btn-nav-toggle-wrapper').classList.add('hidden'); this.showToast("Navigation beendet"); },
            editWindSettings() { this.openModal(); this.switchTab('environment'); },
            openModal() { document.getElementById('main-modal').style.display = 'flex'; this.switchTab(this.tab); },
            closeModal() { document.getElementById('main-modal').style.display = 'none'; },
            
            // Photo Viewer
            showPhoto(src) {
                const overlay = document.getElementById('photo-overlay');
                const img = document.getElementById('photo-overlay-img');
                img.src = src;
                overlay.style.display = 'flex';
            },
            
            switchTab(t) { this.tab = t; this.editingId = null; document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.onclick.toString().includes(`'${t}'`))); this.render(); },
            render() { const c = document.getElementById('tab-content'); c.innerHTML = ''; if (this.editingId) { this.renderForm(c); return; } switch(this.tab) { case 'planning': this.viewPlanning(c); break; case 'fleet': this.viewFleet(c); break; case 'cylinders': this.viewCylinders(c); break; case 'passengers': this.viewPassengers(c); break; case 'logbook': this.viewLogbook(c); break; case 'settings': this.viewSettings(c); break; case 'environment': this.viewEnvironment(c); break; } },
            
            // ... existing view functions (viewFleet, viewCylinders etc) remain same ...
            viewFleet(c) { c.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Ballon-Flotte</h3><button onclick="ui.edit('new')" class="bg-blue-600 px-4 py-2 rounded text-sm">+ Ballon hinzufügen</button></div>`; state.balloons.forEach(b => { const defaultCount = b.defaultCylinders ? b.defaultCylinders.length : 0; c.innerHTML += `<div class="glass-panel p-4 mb-2 flex justify-between items-center"><div><div class="font-bold text-lg">${b.callsign}</div><div class="text-xs text-slate-400">${b.volume}m³ | Std-Flaschen: ${defaultCount} | MTOM: ${b.mtom}kg</div></div><div class="flex gap-2"><button onclick="ui.edit('${b.id}')" class="bg-slate-700 px-3 py-1 rounded">Edit</button><button onclick="ui.delete('balloons','${b.id}')" class="text-red-400 p-1"><i class="fas fa-trash"></i></button></div></div>`; }); },
            viewCylinders(c) { c.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Gasflaschen-Inventar</h3><button onclick="ui.edit('new')" class="bg-blue-600 px-4 py-2 rounded text-sm">+ Flasche hinzufügen</button></div>`; state.cylinders.forEach(cyl => { const isTuvExpired = new Date(cyl.tuv) < new Date(); c.innerHTML += `<div class="glass-panel p-4 mb-2 flex justify-between items-center ${isTuvExpired ? 'border-red-500/50 border' : ''}"><div><div class="font-bold">${cyl.label} (${cyl.type})</div><div class="text-xs text-slate-400">SN: ${cyl.sn} | Tara: ${cyl.tare}kg | Gas: ${cyl.gas}kg | TÜV: <span class="${isTuvExpired ? 'text-red-400 font-bold' : ''}">${cyl.tuv}</span></div></div><div class="flex gap-2"><button onclick="ui.edit('${cyl.id}')" class="bg-slate-700 px-3 py-1 rounded">Edit</button><button onclick="ui.delete('cylinders','${cyl.id}')" class="text-red-400 p-1"><i class="fas fa-trash"></i></button></div></div>`; }); },
            
            setPassengerView(mode) {
                this.passengerMode = mode;
                this.render();
            },
            
            viewPassengers(c) { 
                const isArchive = this.passengerMode === 'archive';
                const listTitle = isArchive ? 'Gäste-Archiv' : 'Warteliste';
                
                // Filter passengers
                let filteredPax = [];
                if (isArchive) {
                    filteredPax = state.passengers.filter(p => (p.flights || 0) > 0);
                } else {
                    filteredPax = state.passengers.filter(p => !p.flights || p.flights === 0);
                }

                c.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">Passagier-Datenbank</h3>
                    <div class="mb-4 glass-panel border border-white/10 p-4">
                         <div class="flex gap-4 border-b border-white/10 pb-2 mb-4 text-sm">
                            <button onclick="ui.setPassengerView('active')" class="${!isArchive ? 'text-blue-400 font-bold border-b-2 border-blue-400' : 'text-slate-500 hover:text-slate-300'} pb-1 transition">Warteliste</button>
                            <button onclick="ui.setPassengerView('archive')" class="${isArchive ? 'text-blue-400 font-bold border-b-2 border-blue-400' : 'text-slate-500 hover:text-slate-300'} pb-1 transition">Archiv (Gefahren)</button>
                        </div>
                        
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-xs uppercase text-slate-400 font-bold">${listTitle}</h4>
                            <button onclick="ui.edit('new')" class="bg-blue-600 px-4 py-2 rounded text-sm hover:bg-blue-500 transition">+ Passagier hinzufügen</button>
                        </div>
                        
                        <div class="space-y-2">
                             ${filteredPax.length === 0 ? `<div class="text-center text-slate-500 italic py-4">Keine Einträge in dieser Liste</div>` : ''}
                             ${filteredPax.map(p => `
                                <div class="glass-panel p-4 flex justify-between items-center ${isArchive ? 'border-l-4 border-green-500/50 bg-slate-900/40' : ''}">
                                    <div>
                                        <div class="font-bold text-white">${p.firstName} ${p.lastName}</div>
                                        <div class="text-xs text-slate-400">${p.weight}kg | ${p.gender} | ${p.phone}</div>
                                        ${isArchive ? `<div class="text-[10px] text-green-400 mt-1"><i class="fas fa-check"></i> ${p.flights} Fahrten | Letzte: ${new Date(p.lastFlight).toLocaleDateString()}</div>` : ''}
                                    </div>
                                    <div class="flex gap-2">
                                        ${!isArchive ? `<button onclick="ui.taufe('${p.firstName}')" class="bg-amber-600/20 text-amber-500 px-2 py-1 rounded text-xs border border-amber-500/30">Taufe</button>` : ''}
                                        ${isArchive ? `<button onclick="ui.viewPassengerHistory('${p.id}')" class="bg-indigo-600/20 text-indigo-400 px-3 py-1 rounded text-xs border border-indigo-500/30 hover:bg-indigo-600 hover:text-white transition" title="Fahrtenbuch"><i class="fas fa-book-open"></i></button>` : ''}
                                        <button onclick="ui.edit('${p.id}')" class="bg-slate-700 px-3 py-1 rounded text-xs hover:bg-slate-600">Edit</button>
                                        <button onclick="ui.delete('passengers','${p.id}')" class="text-red-400 p-1 hover:text-red-300"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                             `).join('')}
                        </div>
                    </div>
                `; 
            },
            
            viewPassengerHistory(paxId) {
                const p = state.passengers.find(x => x.id === paxId);
                if(!p) return;
                
                const logs = state.logs.filter(l => l.pax && l.pax.includes(paxId)).sort((a,b) => new Date(b.start) - new Date(a.start));
                
                document.getElementById('main-modal').style.display = 'flex';
                const c = document.getElementById('tab-content');
                
                c.innerHTML = `
                    <div class="flex items-center gap-4 mb-6">
                        <button onclick="ui.switchTab('passengers')" class="text-slate-400 hover:text-white"><i class="fas fa-arrow-left"></i> Zurück</button>
                        <div>
                            <h3 class="text-xl font-bold text-white">Fahrtenbuch: ${p.firstName} ${p.lastName}</h3>
                            <div class="text-xs text-slate-400">Gesamt: ${logs.length} Fahrten</div>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        ${logs.length === 0 ? '<div class="text-slate-500 italic text-center">Keine Fahrten gefunden.</div>' : 
                            logs.map(l => {
                                const durMs = new Date(l.end) - new Date(l.start);
                                const mins = Math.floor(durMs / 60000);
                                return `
                                    <div class="bg-slate-800 p-4 rounded-lg flex justify-between items-center hover:bg-slate-700/50 transition border border-white/5">
                                        <div>
                                            <div class="font-bold text-blue-400">${new Date(l.start).toLocaleDateString()} <span class="text-slate-500 font-normal text-xs">| ${l.balloon}</span></div>
                                            <div class="text-xs text-slate-300 mt-1"><i class="fas fa-clock"></i> ${Math.floor(mins/60)}h ${mins%60}m | <i class="fas fa-map-marker-alt"></i> ${l.startLoc || '?'} -> ${l.endLoc || '?'}</div>
                                        </div>
                                        <button onclick="ui.showSummary(${l.id})" class="bg-blue-600/20 text-blue-400 p-2 rounded-full hover:bg-blue-600 hover:text-white transition"><i class="fas fa-eye"></i></button>
                                    </div>
                                `;
                            }).join('')
                        }
                    </div>
                `;
            },

            viewLogbook(c) { const logFlights = state.logs.length; const logDurationMs = state.logs.reduce((acc, log) => acc + (new Date(log.end) - new Date(log.start)), 0); const logHours = logDurationMs / 3600000; const totalFlights = (state.pilot.initialFlights || 0) + logFlights; const totalHoursDec = (state.pilot.initialHours || 0) + logHours; const tHrs = Math.floor(totalHoursDec); const tMins = Math.round((totalHoursDec - tHrs) * 60); const timeString = `${tHrs}h ${tMins.toString().padStart(2, '0')}m`; c.innerHTML = `<div class="flex justify-between items-center mb-4"><div><h3 class="text-xl font-bold">Fahrtenbuch</h3><div class="text-xs text-slate-400 mt-1">Gesamt: <span class="text-white font-bold">${totalFlights}</span> Fahrten | <span class="text-white font-bold">${timeString}</span></div></div><button onclick="ui.edit('new')" class="bg-blue-600 px-4 py-2 rounded text-sm">+ Manueller Eintrag</button></div>`; state.logs.sort((a,b)=>new Date(b.start)-new Date(a.start)).forEach(l => { 
                const startStr = ui.formatTime(l.start);
                const endStr = ui.formatTime(l.end);
                c.innerHTML += `<div class="glass-panel p-4 mb-2 flex justify-between items-center"><div><div class="font-bold">${new Date(l.start).toLocaleDateString()} - ${l.balloon}</div><div class="text-xs text-slate-400">${startStr} bis ${endStr} | ${l.notes.substring(0,30)}...</div></div><div class="flex gap-2"><button onclick="ui.showSummary(${l.id})" class="text-blue-400 p-1"><i class="fas fa-eye"></i></button><button onclick="ui.delete('logs',${l.id})" class="text-red-400 p-1"><i class="fas fa-trash"></i></button></div></div>`; 
            }); },

            viewPlanning(c) { if (!state.plannings) { state.plannings = []; saveState(); } if (!state.archive) { state.archive = []; saveState(); } const isArchive = this.planningMode === 'archive'; const listData = isArchive ? state.archive : state.plannings; const listTitle = isArchive ? 'Archiv / Vorlagen' : 'Aktive Planungen'; c.innerHTML = `<h3 class="text-xl font-bold mb-4">Weight & Balance Planung</h3><div class="mb-6 p-4 glass-panel border border-white/10"><div class="flex gap-4 border-b border-white/10 pb-2 mb-2 text-sm"><button onclick="ui.setPlanView('active')" class="${!isArchive ? 'text-blue-400 font-bold border-b-2 border-blue-400' : 'text-slate-500 hover:text-slate-300'} pb-1 transition">Aktive Planungen</button><button onclick="ui.setPlanView('archive')" class="${isArchive ? 'text-blue-400 font-bold border-b-2 border-blue-400' : 'text-slate-500 hover:text-slate-300'} pb-1 transition">Archiv</button></div><div class="flex justify-between items-center mb-2"><h4 class="text-xs uppercase text-slate-400 font-bold">${listTitle}</h4>${!isArchive ? '<button onclick="ui.clearPlanForm()" class="text-xs bg-slate-700 px-3 py-1 rounded hover:bg-slate-600 transition">+ Neue Planung</button>' : ''}</div><div class="max-h-32 overflow-y-auto space-y-1" id="saved-plans-list">${listData.length === 0 ? `<div class="text-xs text-slate-500 italic p-2">${isArchive ? 'Archiv ist leer' : 'Keine aktiven Planungen'}</div>` : listData.sort((a,b) => b.id - a.id).map(p => `<div class="flex justify-between items-center bg-slate-800 p-2 rounded text-xs group hover:bg-slate-700/50 transition"><div class="cursor-pointer flex-1" onclick="${isArchive ? `ui.loadTemplate('${p.id}')` : `ui.loadPlan('${p.id}')`}" title="${isArchive ? 'Als Vorlage laden' : 'Bearbeiten'}"><div class="font-bold text-white flex items-center gap-2">${isArchive ? '<i class="fas fa-history text-slate-500"></i>' : ''} ${p.name}</div><div class="text-slate-400 text-[10px]">${p.date} | ${p.balloonName}</div></div><div class="flex gap-1">${!isArchive ? `<button onclick="ui.archivePlan(${p.id})" class="text-blue-400 hover:text-blue-300 p-1 px-2 bg-slate-900/50 rounded" title="Ins Archiv verschieben"><i class="fas fa-box-archive"></i></button>` : `<button onclick="ui.unarchivePlan(${p.id})" class="text-green-400 hover:text-green-300 p-1 px-2 bg-slate-900/50 rounded" title="Wiederherstellen"><i class="fas fa-box-open"></i></button>`}<button onclick="ui.delete('${isArchive ? 'archive' : 'plannings'}', ${p.id})" class="text-red-400 hover:text-red-300 p-1 px-2 bg-slate-900/50 rounded"><i class="fas fa-trash"></i></button></div></div>`).join('')}</div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><div><label>Bezeichnung der Planung</label><input type="text" id="plan-name" placeholder="z.B. Morgenfahrt Alpen" class="bg-slate-800 border-slate-600 focus:border-blue-500"></div><div><label>Ballon wählen</label><select id="plan-balloon" onchange="ui.selectBalloon()"><option value="">-- Wählen --</option>${state.balloons.map(b => `<option value="${b.id}">${b.callsign}</option>`).join('')}</select></div><div><label>Gasflaschen für diese Fahrt</label><div class="glass-panel p-3 border border-white/5 bg-slate-900/40"><div id="plan-cyl-list" class="space-y-2 mb-3"><div class="text-xs text-slate-500 italic">Keine Flaschen ausgewählt</div></div><div class="flex gap-2 pt-2 border-t border-white/10"><select id="plan-cyl-add-select" class="text-xs bg-slate-800 border-none w-full"><option value="">+ Flasche wählen</option>${state.cylinders.map(c => `<option value="${c.id}">${c.label} (${c.type}) - ${c.gas+c.tare}kg</option>`).join('')}</select><button onclick="ui.addPlanCylinder()" class="bg-blue-600 px-3 rounded text-xs hover:bg-blue-500 shrink-0"><i class="fas fa-plus"></i></button></div></div></div><div><label>Passagiere wählen</label><div class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-40 overflow-y-auto p-2 border border-white/5 rounded" id="plan-pax">${state.passengers.sort((a,b) => (a.flights||0) - (b.flights||0)).map(p => { const isFlown = p.flights > 0; const badge = isFlown ? `<span class="text-green-400 text-[9px] ml-1">✓ ${p.flights}</span>` : ''; return `<label class="flex items-center gap-2 bg-slate-800 p-2 rounded text-[10px] hover:bg-slate-700 cursor-pointer ${isFlown ? 'opacity-75' : ''}"><input type="checkbox" value="${p.id}" onchange="ui.recalcWB()" class="w-4 h-4 shrink-0"> <span class="flex-1 truncate">${p.firstName} ${p.lastName}${badge}</span> <span class="text-slate-400">${p.weight}kg</span></label>`; }).join('')}</div></div></div><div class="space-y-4"><div class="grid grid-cols-1 sm:grid-cols-2 gap-2"><div><label>Startort Temp (°C)</label><input type="number" id="plan-temp" value="15" onchange="ui.recalcWB()"></div><div><label>Zielhöhe (m)</label><input type="number" id="plan-alt" value="1000" onchange="ui.recalcWB()"></div></div><div id="wb-result" class="glass-panel p-6 border-blue-500/30 border min-h-[200px] flex flex-col justify-center text-center"><div class="text-slate-500 italic">Bitte Ballon und Zuladung wählen...</div></div><button onclick="ui.savePlan()" id="btn-save-plan" class="bg-green-600 hover:bg-green-500 w-full py-3 rounded font-bold shadow-lg shadow-green-900/20 mt-4 transition transform active:scale-95 flex items-center justify-center gap-2"><i class="fas fa-save"></i> Planung Speichern</button></div></div>`; },
            viewSettings(c) { const initHrs = Math.floor(state.pilot.initialHours || 0); const initMins = Math.round(((state.pilot.initialHours || 0) - initHrs) * 60); const initTimeStr = `${initHrs}:${initMins.toString().padStart(2, '0')}`; c.innerHTML = `
                <div class="space-y-6">
                    <!-- SECTION 1: PILOT -->
                    <div class="bg-white/5 p-4 rounded-lg">
                        <h4 class="text-blue-400 font-bold mb-3 border-b border-white/10 pb-1">Pilot & Basisdaten</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label>Name des Piloten</label><input type="text" id="set-pilot-name" value="${state.pilot.name}" onchange="ui.saveSettings(true)"></div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label>Gewicht (kg)</label><input type="number" id="set-pilot-weight" value="${state.pilot.weight}" onchange="ui.saveSettings(true)"></div>
                                <div><label>Stunden (hh:mm)</label><input type="text" id="set-pilot-hours" value="${initTimeStr}" placeholder="hh:mm" onchange="ui.saveSettings(true)"></div>
                            </div>
                            <div class="md:col-span-2">
                                <label>Bisherige Fahrten</label>
                                <input type="number" id="set-pilot-flights" value="${state.pilot.initialFlights || 0}">
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 2: DISPLAY & UNITS -->
                    <div class="bg-white/5 p-4 rounded-lg">
                        <h4 class="text-blue-400 font-bold mb-3 border-b border-white/10 pb-1">Anzeige & Einheiten</h4>
                        <div class="space-y-3">
                             <div class="flex items-center justify-between bg-black/20 p-2 rounded">
                                 <span class="text-sm">Betriebsmodus: <b>${state.settings.mode === 'gps' ? 'GPS LIVE' : 'SIMULATION'}</b></span>
                                 <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="set-mode-toggle" class="sr-only peer" ${state.settings.mode === 'gps' ? 'checked' : ''} onchange="ui.saveSettings(true)"><div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div></label>
                             </div>
                             <div class="flex items-center justify-between bg-black/20 p-2 rounded">
                                 <span class="text-sm">Zeiten in UTC anzeigen</span>
                                 <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="set-use-utc" class="sr-only peer" ${state.settings.useUTC ? 'checked' : ''} onchange="ui.saveSettings(true)"><div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div></label>
                             </div>
                             <div class="grid grid-cols-2 gap-2">
                                <div><label>Kartenstil</label><select id="set-map-style" onchange="ui.saveSettings(true)"><option value="dark" ${state.settings.mapStyle==='dark'?'selected':''}>Dark Matter (Dunkel)</option><option value="light" ${state.settings.mapStyle==='light'?'selected':''}>OpenStreetMap (Hell)</option><option value="sat" ${state.settings.mapStyle==='sat'?'selected':''}>Satellit</option></select></div>
                                <div><label>Track Farbe</label><input type="color" id="set-track-color" value="${state.settings.trackColor}" onchange="ui.saveSettings(true)"></div>
                             </div>
                             <div class="pt-2"><label>Gemini API Key</label><input type="password" id="set-api-key" value="${state.settings.apiKey || ''}" placeholder="..." onchange="ui.saveSettings(true)"></div>
                        </div>
                    </div>

                    <!-- SECTION 3: STORAGE -->
                    <div class="bg-white/5 p-4 rounded-lg">
                        <h4 class="text-amber-400 font-bold mb-3 border-b border-white/10 pb-1">Speicher & Bereinigung</h4>
                        <div class="flex items-end gap-2">
                            <div class="flex-1">
                                <label class="text-[10px]">Fotos aufbewahren (Tage)</label>
                                <input type="number" id="set-image-retention" value="${state.settings.imageRetention || 30}" onchange="ui.saveSettings(true)" class="bg-slate-800 border border-slate-600 rounded p-2 text-sm w-full">
                            </div>
                            <button onclick="flightManager.cleanOldPhotosNow()" class="bg-amber-700/50 hover:bg-amber-600 text-amber-100 p-2 rounded text-sm mb-[1px]">Jetzt bereinigen</button>
                        </div>
                    </div>

                    <!-- SECTION 3.5: AI SETTINGS -->
                    <div class="bg-white/5 p-4 rounded-lg mt-4">
                        <h4 class="text-purple-400 font-bold mb-3 border-b border-white/10 pb-1">KI Konfiguration</h4>
                        <div class="flex items-end gap-2">
                            <div class="flex-1">
                                <label class="text-[10px]">Maximale Wortanzahl für Taufnamen</label>
                                <input type="number" id="set-baptism-words" value="${state.settings.baptismMaxWords || 15}" onchange="ui.saveSettings(true)" class="bg-slate-800 border border-slate-600 rounded p-2 text-sm w-full">
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 4: DANGER ZONE -->
                    <div class="bg-red-900/10 border border-red-900/30 p-4 rounded-lg mt-8">
                        <h4 class="text-red-400 font-bold mb-3 text-sm uppercase">System & Daten (Gefahrenzone)</h4>
                        <div class="flex flex-col gap-2">
                            <button onclick="system.exportData()" class="bg-slate-800 hover:bg-slate-700 py-2 rounded text-sm border border-white/10">Backup erstellen (Export)</button>
                            <button onclick="system.triggerImport()" class="bg-slate-800 hover:bg-slate-700 py-2 rounded text-sm border border-white/10 text-blue-200">Backup wiederherstellen (Import)</button>
                            <button onclick="system.resetData()" class="bg-red-900/40 hover:bg-red-900/60 text-red-200 py-2 rounded text-sm mt-2 border border-red-500/30">Werkseinstellungen (Reset)</button>
                        </div>
                    </div>
                </div>`; 
            },
            
            viewEnvironment(c) { c.innerHTML = `<h3 class="text-xl font-bold mb-4">Wetter & Wind Simulation</h3><div class="glass-panel p-6 border-white/10 border"><div class="flex justify-between items-start mb-4"><p class="text-sm text-slate-400">Hier definierst du die Windschichten für die Simulation. Der Ballon bewegt sich basierend auf der aktuellen Höhe und diesen Werten.</p><button onclick="weatherService.fetchLiveWind()" class="bg-green-600/20 text-green-400 border border-green-500/50 px-3 py-1 rounded text-xs whitespace-nowrap hover:bg-green-600 hover:text-white transition"><i class="fas fa-satellite-dish mr-1"></i> Live-Daten laden</button></div><div class="grid grid-cols-4 gap-2 text-xs uppercase text-slate-500 font-bold mb-2"><div>Höhe (m)</div><div>Richtung (°)</div><div>Speed (kt)</div><div></div></div><div id="wind-rows" class="space-y-2 mb-4">${state.windLayers.sort((a,b)=>a.alt-b.alt).map((w, idx) => `<div class="grid grid-cols-4 gap-2 items-center"><input type="number" class="wind-edit-alt" value="${w.alt}" placeholder="Höhe"><input type="number" class="wind-edit-dir" value="${w.dir}" placeholder="Dir"><input type="number" class="wind-edit-spd" value="${w.speed}" placeholder="Knots"><button onclick="ui.removeWindLayer(${idx})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button></div>`).join('')}</div><button onclick="ui.addWindLayer()" class="bg-slate-700 px-4 py-2 rounded text-xs mb-6">+ Schicht hinzufügen</button><button onclick="ui.saveEnvironment()" class="bg-blue-600 w-full py-3 rounded font-bold shadow-lg">Wetterdaten Speichern</button><div class="mt-4"><label class="text-xs uppercase text-slate-500 font-bold mb-1 block">Wind-Filter (Grad)</label><div class="flex items-center gap-2"><input type="number" id="set-wind-threshold" class="w-20 bg-slate-800 text-sm p-1 rounded" value="${state.settings.windThreshold || 5}"><span class="text-xs text-slate-400">Nur Änderungen > X° anzeigen</span></div></div><p class="text-[10px] text-slate-500 mt-2 text-center">Live-Daten bereitgestellt durch Open-Meteo.com (Kein Key erforderlich)</p></div>`; },
            
            // --- WIND FILTER LOGIC ---
            renderWind() { 
                const container = document.getElementById('wind-layers-container'); 
                container.innerHTML = ''; 
                
                const isKmh = state.settings.unitSpeed === 'kmh';
                const unitLabel = isKmh ? 'km/h' : 'kt';
                const threshold = state.settings.windThreshold || 5;

                const layerMap = new Map();
                
                state.windLayers.forEach(l => layerMap.set(l.alt, { ...l, isMeasured: false }));
                
                if (state.measuredWindLayers) {
                    state.measuredWindLayers.forEach(l => layerMap.set(l.alt, { ...l, isMeasured: true }));
                }

                const sortedLayers = Array.from(layerMap.values()).sort((a, b) => b.alt - a.alt);

                let lastKeptDir = null;
                
                sortedLayers.forEach((layer, index) => {
                    let keep = false;
                    
                    if (index === 0) keep = true;
                    else if (layer.isMeasured) keep = true;
                    else {
                        if (lastKeptDir === null) {
                            keep = true;
                        } else {
                            let diff = Math.abs(layer.dir - lastKeptDir);
                            if (diff > 180) diff = 360 - diff;
                            if (diff >= threshold) keep = true;
                        }
                    }

                    if (keep) {
                        let speed = layer.speed;
                        if (isKmh) speed *= 1.852; 

                        const colorClass = layer.isMeasured ? 'text-green-400 font-bold' : 'text-blue-300';
                        const labelClass = layer.isMeasured ? 'text-green-400' : '';
                        const arrowClass = layer.isMeasured ? 'compass-arrow arrow-green' : 'compass-arrow';

                        // HIGHLIGHT CURRENT ALTITUDE
                        const isCurrentAlt = Math.abs(layer.alt - simulation.alt) < 25;
                        const activeClass = isCurrentAlt ? 'active-altitude' : '';

                        const div = document.createElement('div'); 
                        div.className = `wind-layer ${activeClass}`; 
                        div.dataset.alt = layer.alt; // Added dataset
                        div.innerHTML = `<div class="${colorClass}">${layer.alt}m</div><div class="${arrowClass}" style="transform: rotate(${layer.dir}deg)"></div><div class="${labelClass}">${speed.toFixed(1)}${unitLabel}</div>`; 
                        container.appendChild(div);
                        
                        lastKeptDir = layer.dir;
                    }
                });
            },
            
            addWindLayer() { const container = document.getElementById('wind-rows'); const div = document.createElement('div'); div.className = "grid grid-cols-4 gap-2 items-center"; div.innerHTML = `<input type="number" class="wind-edit-alt" value="0" placeholder="Höhe"><input type="number" class="wind-edit-dir" value="0" placeholder="Dir"><input type="number" class="wind-edit-spd" value="0" placeholder="Knots"><button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>`; container.appendChild(div); },
            removeWindLayer(idx) { state.windLayers.splice(idx, 1); this.render(); },
            saveEnvironment() { const newLayers = []; const rows = document.querySelectorAll('#wind-rows > div'); rows.forEach(row => { const alt = parseFloat(row.querySelector('.wind-edit-alt').value); const dir = parseFloat(row.querySelector('.wind-edit-dir').value); const spd = parseFloat(row.querySelector('.wind-edit-spd').value); if (!isNaN(alt)) { newLayers.push({ alt, dir, speed: spd }); } }); state.windLayers = newLayers; saveState(); this.renderWind(); ui.showToast("Wetterdaten gespeichert!", "success"); },
            
            // --- HELPER FUNCTIONS ---
            selectBalloon() { const bId = document.getElementById('plan-balloon').value; const list = document.getElementById('plan-cyl-list'); list.innerHTML = ''; if (!bId) { list.innerHTML = '<div class="text-xs text-slate-500 italic">Keine Flaschen ausgewählt</div>'; return; } const b = state.balloons.find(x => x.id === bId); if (b.defaultCylinders && b.defaultCylinders.length > 0) { b.defaultCylinders.forEach(id => { this.addPlanCylinder(id); }); } else { list.innerHTML = '<div class="text-xs text-slate-500 italic">Keine Standard-Flaschen definiert</div>'; } this.recalcWB(); },
            
            recalcWB() {
                const bId = document.getElementById('plan-balloon').value;
                if (!bId) return;
                const b = state.balloons.find(x => x.id === bId);
                const temp = parseFloat(document.getElementById('plan-temp').value);
                const alt = parseFloat(document.getElementById('plan-alt').value);
                
                const selectedCylIds = [];
                document.querySelectorAll('.plan-cyl-item').forEach(el => selectedCylIds.push(el.dataset.pid));
                const selectedCyls = selectedCylIds.map(id => state.cylinders.find(c => c.id === id)).filter(Boolean);
                const selectedPax = Array.from(document.querySelectorAll('#plan-pax input:checked')).map(i => state.passengers.find(p => p.id === i.value));
                
                const totalCylWeight = selectedCyls.reduce((sum, c) => sum + c.tare + c.gas, 0);
                const totalPaxWeight = selectedPax.reduce((sum, p) => sum + p.weight, 0);
                const totalWeight = b.weight + state.pilot.weight + totalCylWeight + totalPaxWeight;

                const altSteps = [0, 1000, 2000, 3000];
                const tempSteps = [0, 15, 30];
                const cAlt = Math.max(0, Math.min(3000, alt));
                const cTemp = Math.max(0, Math.min(30, temp));
                let i = 0; while (i < altSteps.length - 2 && cAlt > altSteps[i+1]) i++;
                let j = 0; while (j < tempSteps.length - 2 && cTemp > tempSteps[j+1]) j++;
                const rAlt = (cAlt - altSteps[i]) / (altSteps[i+1] - altSteps[i]);
                const rTemp = (cTemp - tempSteps[j]) / (tempSteps[j+1] - tempSteps[j]);
                const q11 = b.matrix[i][j]; const q12 = b.matrix[i][j+1]; const q21 = b.matrix[i+1][j]; const q22 = b.matrix[i+1][j+1];
                const r1 = q11 + (q12 - q11) * rTemp; const r2 = q21 + (q22 - q21) * rTemp;
                const liftFactor = r1 + (r2 - r1) * rAlt;
                const maxLift = b.volume * liftFactor;

                const res = document.getElementById('wb-result');
                const isOverMTOM = totalWeight > b.mtom;
                const isOverLift = totalWeight > maxLift;

                res.innerHTML = `
                    <div class="text-lg font-bold mb-4">Analyse für ${b.callsign}</div>
                    <div class="space-y-1 text-sm text-left max-w-xs mx-auto mb-4">
                        <div class="flex justify-between"><span>Ballon leer:</span> <span>${b.weight} kg</span></div>
                        <div class="flex justify-between"><span>Pilot:</span> <span>${state.pilot.weight} kg</span></div>
                        <div class="flex justify-between"><span>Passagiere:</span> <span>${totalPaxWeight} kg</span></div>
                        <div class="flex justify-between"><span>Gasflaschen (${selectedCyls.length}):</span> <span>${totalCylWeight} kg</span></div>
                        <hr class="border-white/10 my-1">
                        <div class="flex justify-between font-bold text-lg"><span>Gesamt:</span> <span>${Math.round(totalWeight)} kg</span></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="p-2 rounded ${isOverMTOM ? 'bg-red-900/40 text-red-300 border border-red-500/50' : 'bg-green-900/40 text-green-300 border border-green-500/50'}">MTOM: ${b.mtom}kg<br><b>${isOverMTOM ? 'ÜBERSCHRITTEN' : 'OK'}</b></div>
                        <div class="p-2 rounded ${isOverLift ? 'bg-red-900/40 text-red-300 border border-red-500/50' : 'bg-green-900/40 text-green-300 border border-green-500/50'}">TRAGKRAFT: ${Math.round(maxLift)}kg<br><b>${isOverLift ? 'ZU SCHWER' : 'OK'}</b></div>
                    </div>
                    <div class="mt-4 text-xs italic text-slate-500">Berechnet für ${cAlt}m AMSL bei ${cTemp}°C<br>(Tragkraftfaktor: ${liftFactor.toFixed(4)} kg/m³)</div>
                `;
            },
            
            showStartDialog() {
                const c = document.getElementById('tab-content');
                document.getElementById('main-modal').style.display = 'flex';
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                
                // Get all balloons for dropdown
                const balloonOptions = state.balloons.map(b => 
                    `<option value="${b.id}">${b.callsign}</option>`
                ).join('');

                c.innerHTML = `
                    <h3 class="text-2xl font-bold mb-6 text-center">Fahrt Starten</h3>
                    <div class="grid gap-4 max-w-md mx-auto">
                        <div class="bg-slate-800 p-4 rounded-xl shadow-lg border border-white/10">
                            <h4 class="font-bold text-slate-300 mb-2 text-sm uppercase">Spontanfahrt</h4>
                            <div class="mb-4">
                                <label class="text-xs text-slate-400 block mb-1">Ballon wählen</label>
                                <select id="spontan-balloon-select" class="w-full bg-slate-700 border border-white/10 rounded p-2 text-white text-sm">
                                    ${state.balloons.length === 0 ? '<option value="">Keine Ballone verfügbar</option>' : balloonOptions}
                                </select>
                            </div>
                            <button onclick="flightManager.startRecording(null, document.getElementById('spontan-balloon-select').value)" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition active:scale-95">
                                <i class="fas fa-play"></i> Starten
                            </button>
                        </div>
                        
                        <div class="text-center text-slate-500 text-xs my-2">- ODER GEPLANTE FAHRT WÄHLEN -</div>
                        
                        <div class="space-y-2 max-h-60 overflow-y-auto">
                            ${state.plannings.length === 0 ? '<div class="text-center text-slate-500 italic">Keine aktiven Planungen vorhanden</div>' : 
                                state.plannings.map(p => `
                                    <button onclick="flightManager.startRecording('${p.id}')" class="w-full bg-slate-800 hover:bg-slate-700 p-3 rounded-lg flex justify-between items-center text-left border border-white/5 transition active:scale-95">
                                        <div>
                                            <div class="font-bold text-white">${p.name}</div>
                                            <div class="text-[10px] text-slate-400">${p.date} | ${p.balloonName}</div>
                                        </div>
                                        <i class="fas fa-chevron-right text-slate-500"></i>
                                    </button>
                                `).join('')
                            }
                        </div>
                    </div>
                `;
            },

            addPlanCylinder(idOverride) { const sel = document.getElementById('plan-cyl-add-select'); const id = idOverride || sel.value; if (!id) return; const list = document.getElementById('plan-cyl-list'); if (list.querySelector(`[data-pid="${id}"]`)) return; if(list.innerHTML.includes('Keine Flaschen')) list.innerHTML = ''; const cyl = state.cylinders.find(c => c.id === id); const div = document.createElement('div'); div.className = "flex justify-between items-center bg-slate-800 p-2 rounded mb-1 text-xs plan-cyl-item"; div.setAttribute('data-pid', id); div.innerHTML = `<div><div class="font-bold">${cyl.label}</div><div class="text-slate-400 text-[10px]">Total: ${cyl.gas+cyl.tare}kg</div></div><button onclick="ui.removePlanCylinder(this)" class="text-red-400 hover:text-red-300 px-2"><i class="fas fa-trash-alt"></i></button>`; list.appendChild(div); if (!idOverride) this.recalcWB(); },
            removePlanCylinder(btn) { btn.parentElement.remove(); this.recalcWB(); },

            clearPlanForm() {
                this.editingPlanId = null; // Reset to new mode

                // Reset to default empty state
                document.getElementById('plan-balloon').value = "";
                document.getElementById('plan-name').value = "";
                document.getElementById('plan-temp').value = "15";
                document.getElementById('plan-alt').value = "1000";
                
                document.getElementById('plan-cyl-list').innerHTML = '<div class="text-xs text-slate-500 italic">Keine Flaschen ausgewählt</div>';
                document.querySelectorAll('#plan-pax input').forEach(cb => cb.checked = false);
                document.getElementById('wb-result').innerHTML = '<div class="text-slate-500 italic">Bitte Ballon und Zuladung wählen...</div>';

                // Reset Button Text
                const btn = document.getElementById('btn-save-plan');
                if(btn) { btn.innerHTML = '<i class="fas fa-save"></i> Planung Speichern'; btn.className = btn.className.replace('bg-blue-600', 'bg-green-600'); }
            },
            
            _fillPlanForm(plan) {
                // Set Balloon
                document.getElementById('plan-balloon').value = plan.balloonId;
                document.getElementById('plan-name').value = plan.name;
                document.getElementById('plan-temp').value = plan.temp;
                document.getElementById('plan-alt').value = plan.alt;

                // Clear current cylinders list visual
                const list = document.getElementById('plan-cyl-list');
                list.innerHTML = '';
                
                // Add cylinders from plan
                if (plan.cylinders && plan.cylinders.length > 0) {
                    plan.cylinders.forEach(cylId => this.addPlanCylinder(cylId));
                } else {
                    list.innerHTML = '<div class="text-xs text-slate-500 italic">Keine Flaschen ausgewählt</div>';
                }

                // Check passengers
                document.querySelectorAll('#plan-pax input').forEach(cb => {
                    cb.checked = plan.passengers.includes(cb.value);
                });

                this.recalcWB();
            },

            loadPlan(id) {
                const plan = state.plannings.find(p => p.id == id);
                if(!plan) return;
                this._fillPlanForm(plan);
                this.editingPlanId = plan.id; // Set edit mode (Update)
                
                const btn = document.getElementById('btn-save-plan');
                if(btn) { btn.innerHTML = '<i class="fas fa-pen"></i> Änderung Speichern'; btn.className = btn.className.replace('bg-green-600', 'bg-blue-600'); }
            },

            loadTemplate(id) {
                const plan = state.archive.find(p => p.id == id);
                if(!plan) return;
                this._fillPlanForm(plan);
                this.editingPlanId = null; // New Mode (Create copy)
                
                // Pre-fill name with "Kopie von..." to indicate template usage
                document.getElementById('plan-name').value = `${plan.name} (Kopie)`;
                
                const btn = document.getElementById('btn-save-plan');
                if(btn) { btn.innerHTML = '<i class="fas fa-save"></i> Als neue Planung Speichern'; btn.className = btn.className.replace('bg-blue-600', 'bg-green-600'); }
            },

            showSelectionModal(title, items, onSelect) {
                const overlay = document.getElementById('selection-overlay');
                const titleEl = document.getElementById('sel-title');
                const contentEl = document.getElementById('sel-content');
                
                titleEl.innerText = title;
                contentEl.innerHTML = '';
                
                if (items.length === 0) {
                    contentEl.innerHTML = '<div class="text-slate-400 text-center italic p-4">Keine Einträge verfügbar</div>';
                } else {
                    items.forEach((item) => {
                        const btn = document.createElement('button');
                        btn.className = "w-full text-left bg-slate-800 hover:bg-slate-700 p-3 rounded mb-1 flex justify-between items-center transition";
                        btn.innerHTML = `<div><div class="font-bold text-white">${item.main}</div><div class="text-xs text-slate-400">${item.sub}</div></div><i class="fas fa-plus text-slate-500"></i>`;
                        btn.onclick = () => {
                            onSelect(item.id);
                            overlay.style.display = 'none';
                        };
                        contentEl.appendChild(btn);
                    });
                }
                
                overlay.style.display = 'flex';
            },

            addLogCylinder(logId) {
                const log = state.logs.find(l => l.id == logId);
                if(!log) return;
                
                // Prepare items
                const items = state.cylinders.map(c => ({
                    id: c.id,
                    main: c.label,
                    sub: `${c.type} | ${c.gas + c.tare}kg`
                }));
                
                this.showSelectionModal("Gasflasche hinzufügen", items, (selectedId) => {
                    log.cylinders.push(selectedId);
                    saveState();
                    this.showSummary(logId, true); // Refresh
                    this.showToast("Flasche hinzugefügt");
                });
            },

            addLogPassenger(logId) {
                const log = state.logs.find(l => l.id == logId);
                if(!log) return;
                
                // Filter passengers not already in log
                const available = state.passengers.filter(p => !log.pax.includes(p.id));
                
                if(available.length === 0) {
                    this.showToast("Alle Passagiere bereits an Bord", "error");
                    return;
                }
                
                const items = available.map(p => ({
                    id: p.id,
                    main: `${p.firstName} ${p.lastName}`,
                    sub: `${p.weight}kg | ${p.flights || 0} Fahrten`
                }));
                
                this.showSelectionModal("Passagier hinzufügen", items, (selectedId) => {
                    const p = state.passengers.find(px => px.id === selectedId);
                    if (p) {
                        log.pax.push(p.id);
                        
                        // Update Stats
                        p.flights = (p.flights || 0) + 1;
                        const logDate = new Date(log.start);
                        const pDate = p.lastFlight ? new Date(p.lastFlight) : new Date(0);
                        if (logDate > pDate) {
                            p.lastFlight = log.start;
                        }
                        
                        saveState();
                        this.showSummary(logId, true); // Refresh UI
                        this.showToast(`${p.firstName} hinzugefügt`);
                    }
                });
            },
            
            removeLogPassenger(logId, paxId) {
                const log = state.logs.find(l => l.id == logId);
                if(!log) return;
                
                log.pax = log.pax.filter(id => id !== paxId);
                
                // Update Stats (decrement)
                const p = state.passengers.find(px => px.id == paxId);
                if(p) {
                    p.flights = Math.max(0, (p.flights || 1) - 1);
                }
                
                saveState();
                this.showSummary(logId, true);
                this.showToast("Passagier entfernt");
            },

            saveSummaryChanges(logId) {
                const log = state.logs.find(l => l.id == logId);
                if (log) {
                    log.startLoc = document.getElementById('sum-start').value;
                    log.endLoc = document.getElementById('sum-end').value;
                    log.notes = document.getElementById('sum-notes').value;
                    
                    // Save baptism names
                    log.pax.forEach(pid => {
                        const input = document.getElementById(`bapt-name-${pid}`);
                        if(input) {
                            const p = state.passengers.find(px => px.id == pid);
                            if(p && input.value.trim() !== "") {
                                p.baptism = true;
                                p.baptismName = input.value.trim();
                            }
                        }
                    });

                    saveState();
                    this.showSummary(logId, false); // Switch to read mode
                    ui.showToast("Änderungen gespeichert");
                }
            },
            
            archivePlanFromSummary(planId, btn) {
                this.archivePlan(planId);
                btn.remove();
                ui.showToast("Planung archiviert");
            },
            
            exportGPX(logId) {
                const log = state.logs.find(l => l.id == logId);
                if (!log || !log.track || log.track.length === 0) { ui.showToast("Kein Track vorhanden!", "error"); return; }
                
                let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="AeroNav">
  <trk>
    <name>Flight ${new Date(log.start).toLocaleDateString()}</name>
    <trkseg>`;
    
                log.track.forEach(pt => {
                    gpx += `\n      <trkpt lat="${pt[0]}" lon="${pt[1]}"><ele>${pt[2]}</ele></trkpt>`;
                });
                
                gpx += `\n    </trkseg>\n  </trk>\n</gpx>`;
                
                const blob = new Blob([gpx], {type: 'application/gpx+xml'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `flight-${logId}.gpx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            },

            generateReportImage(logId) {
                const log = state.logs.find(l => l.id == logId);
                if (!log) return;
                
                const loader = document.getElementById('loading-overlay');
                loader.classList.remove('hidden');
                
                const stage = document.getElementById('report-stage');
                // Ensure stage is visible to renderer but offscreen
                stage.style.display = 'block'; 
                
                // Data prep
                const balloon = state.balloons.find(b => b.callsign === log.balloon);
                const balloonImg = balloon ? balloon.image : null;
                const durMs = new Date(log.end) - new Date(log.start);
                const hrs = Math.floor(durMs / 3600000);
                const mins = Math.floor((durMs % 3600000) / 60000);
                const dateStr = new Date(log.start).toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                // Passenger List for Report (Names only)
                const paxListHtml = log.pax.map(pid => {
                    const p = state.passengers.find(px => px.id == pid);
                    if (!p) return '';
                    const baptism = p.baptismName ? `<div class="text-[10px] text-amber-400 italic font-serif mt-0.5">${p.baptismName}</div>` : '';
                    return `<div class="bg-white/5 p-2 rounded text-sm text-slate-300"><div>${p.firstName} ${p.lastName}</div>${baptism}</div>`;
                }).join('');

                // HTML Structure for Report
                stage.innerHTML = `
                    <div class="border border-white/20 rounded-xl overflow-hidden bg-slate-900 shadow-2xl relative">
                        <!-- Header Banner -->
                        <div class="h-40 relative bg-slate-800 overflow-hidden">
                            ${balloonImg ? `<div class="absolute inset-0 bg-cover bg-center opacity-60" style="background-image: url('${balloonImg}')"></div>` : `<div class="absolute inset-0 bg-gradient-to-r from-blue-900 to-slate-900"></div>`}
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>
                            <div class="absolute bottom-6 left-8">
                                <h1 class="text-4xl font-bold text-white mb-1">Flight Report</h1>
                                <div class="text-blue-300 text-lg font-mono">${log.balloon} | ${dateStr}</div>
                            </div>
                            <div class="absolute top-6 right-8 text-right">
                                <div class="text-white/50 text-xs uppercase tracking-widest">AeroNav Pilot</div>
                                <div class="text-white font-bold text-xl">${state.pilot.name}</div>
                            </div>
                        </div>
                        
                        <div class="p-8">
                            <!-- Stats Grid -->
                            <div class="grid grid-cols-4 gap-4 mb-8">
                                <div class="bg-white/5 p-4 rounded-lg text-center border border-white/5">
                                    <div class="text-slate-400 text-xs uppercase">Dauer</div>
                                    <div class="text-2xl font-bold text-white">${hrs}h ${mins}m</div>
                                </div>
                                <div class="bg-white/5 p-4 rounded-lg text-center border border-white/5">
                                    <div class="text-slate-400 text-xs uppercase">Max Höhe</div>
                                    <div class="text-2xl font-bold text-blue-400">${Math.round(log.maxAlt || 0)} m</div>
                                </div>
                                <div class="bg-white/5 p-4 rounded-lg text-center border border-white/5">
                                    <div class="text-slate-400 text-xs uppercase">Max Speed</div>
                                    <div class="text-2xl font-bold text-yellow-400">${Math.round(log.maxSpeed || 0)} km/h</div>
                                </div>
                                <div class="bg-white/5 p-4 rounded-lg text-center border border-white/5">
                                    <div class="text-slate-400 text-xs uppercase">Passagiere</div>
                                    <div class="text-2xl font-bold text-green-400">${log.pax.length}</div>
                                </div>
                            </div>

                            <!-- Locations -->
                            <div class="flex justify-between items-center mb-8 px-4 py-4 bg-white/5 rounded-lg border border-white/5">
                                <div>
                                    <div class="text-slate-500 text-xs uppercase mb-1">Start</div>
                                    <div class="text-white font-bold text-lg leading-tight">${log.startLoc || 'Unbekannt'}</div>
                                    <div class="text-slate-600 text-xs mt-1">${ui.formatTime(log.start)}</div>
                                </div>
                                <div class="text-slate-600"><i class="fas fa-arrow-right"></i></div>
                                <div class="text-right">
                                    <div class="text-slate-500 text-xs uppercase mb-1">Landung</div>
                                    <div class="text-white font-bold text-lg leading-tight">${log.endLoc || 'Unbekannt'}</div>
                                    <div class="text-slate-600 text-xs mt-1">${ui.formatTime(log.end)}</div>
                                </div>
                            </div>
                            
                            <!-- Notes & Passengers -->
                            <div class="grid grid-cols-2 gap-6 mb-8">
                                <div>
                                    <h4 class="text-slate-500 text-xs uppercase mb-2">Bemerkungen</h4>
                                    <div class="bg-white/5 p-3 rounded-lg text-sm text-slate-300 min-h-[80px] border border-white/5 whitespace-pre-line">
                                        ${log.notes || 'Keine besonderen Vorkommnisse.'}
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-slate-500 text-xs uppercase mb-2">Gästeliste</h4>
                                    <div class="grid grid-cols-1 gap-2 max-h-[120px] overflow-hidden">
                                        ${paxListHtml || '<div class="text-slate-500 italic text-sm">Keine Passagiere</div>'}
                                    </div>
                                </div>
                            </div>

                            <!-- Map & Profile -->
                            <div class="grid grid-cols-3 gap-6 h-64">
                                <div class="col-span-2 bg-black rounded-lg border border-white/20 overflow-hidden relative" id="report-map-container" style="height: 100%;"></div>
                                <div class="col-span-1 bg-slate-800/50 rounded-lg border border-white/5 p-2 flex flex-col">
                                    <div class="text-xs text-slate-500 mb-2 text-center uppercase">Höhenprofil</div>
                                    <div class="flex-1 relative"><canvas id="report-altitude-chart"></canvas></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="px-8 py-4 bg-black/20 border-t border-white/5 flex justify-between items-center text-[10px] text-slate-500">
                            <div>Generated by AeroNav Balloon Pilot</div>
                            <div>${new Date().toLocaleString()}</div>
                        </div>
                    </div>
                `;

                // --- Init Report Map ---
                const mapContainer = document.getElementById('report-map-container');
                // Ensure container has size before init
                mapContainer.style.width = "100%";
                mapContainer.style.height = "100%";
                
                const reportMap = L.map(mapContainer, { zoomControl: false, attributionControl: false });
                
                // Style logic for report map
                const style = state.settings.mapStyle || 'dark';
                let tileUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
                if (style === 'light') tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                else if (style === 'sat') tileUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
                
                L.tileLayer(tileUrl).addTo(reportMap);
                
                // Important: force size recalculation because container was hidden/offscreen
                reportMap.invalidateSize();

                if (log.track && log.track.length > 0) {
                    const line = L.polyline(log.track, { color: '#3b82f6', weight: 4 }).addTo(reportMap);
                    reportMap.fitBounds(line.getBounds(), { padding: [30, 30] });
                } else {
                    reportMap.setView([51.1657, 10.4515], 6);
                }

                // --- Init Report Chart ---
                const ctx = document.getElementById('report-altitude-chart').getContext('2d');
                const altData = log.track ? log.track.map(p => p[2]) : [];
                const labels = altData.map((_, i) => i);
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: altData,
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: true,
                            pointRadius: 0,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { display: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#64748b', font: { size: 8 } } }
                        }
                    }
                });

                // --- Capture ---
                setTimeout(() => {
                    html2canvas(stage, {
                        useCORS: true,
                        backgroundColor: '#0f172a',
                        scale: 2 // High res
                    }).then(canvas => {
                        loader.classList.add('hidden');
                        const link = document.createElement('a');
                        link.download = `Flight-Report-${log.balloon}-${dateStr}.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        ui.showToast("Bericht erstellt!");
                        stage.innerHTML = ''; // Clean up
                        stage.style.display = 'none'; // Hide again
                    }).catch(err => {
                        loader.classList.add('hidden');
                        console.error(err);
                        ui.showToast("Fehler beim Export", "error");
                    });
                }, 1500); // Wait for map tiles
            },

            // --- ADD MISSING FUNCTION ---
            taufe(name) { 
                 // Simple toast notification instead of alert
                 this.showToast(`${name} wurde erfolgreich getauft!`, 'success');
            }
        };

        // --- INIT ---
        window.onload = function() {
            mapManager.init();
            simulation.init();
            flightManager.init();
            ui.init();
            
            // Initial Render logic based on default tab
            ui.render();
        };

    </script>
</body>
</html>
